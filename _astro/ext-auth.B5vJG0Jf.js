const e="latest/en/plugins/authentication/ext-auth.md",t="docs",n="latest/en/plugins/authentication/ext-auth",i='## Function Description\nThe `ext-auth` plugin implements sending authentication requests to an external authorization service to check whether the client request is authorized. This plugin is implemented with reference to Envoy\'s native [ext_authz filter](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/ext_authz_filter), which covers some capabilities for connecting to HTTP services.\n\n## Execution Properties\nPlugin Execution Phase: `Authentication Phase`  \nPlugin Execution Priority: `360`\n\n## Configuration Fields\n| Name                            | Data Type | Required | Default Value | Description                                                                                                                                                            |\n| ------------------------------- | --------- | -------- | ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| `http_service`                  | object    | Yes      | -             | Configuration for the external authorization service                                                                                                                   |\n| `failure_mode_allow`            | bool      | No       | false         | When set to true, client requests will still be accepted even if communication with the authorization service fails or the authorization service returns an HTTP 5xx error |\n| `failure_mode_allow_header_add` | bool      | No       | false         | When both `failure_mode_allow` and `failure_mode_allow_header_add` are set to true, if communication with the authorization service fails or returns an HTTP 5xx error, the request header will include `x-envoy-auth-failure-mode-allowed: true` |\n| `status_on_error`               | int       | No       | 403           | Sets the HTTP status code returned to the client when the authorization service is unreachable or returns a 5xx status code. The default status code is `403`          |\n\n### Configuration Fields for Each Item in `http_service`\n| Name                     | Data Type | Required | Default Value | Description                                  |\n| ------------------------ | --------- | -------- | ------------- | -------------------------------------------- |\n| `endpoint_mode`          | string    | No       | envoy         | Select either `envoy` or `forward_auth` as an optional choice |\n| `endpoint`               | object    | Yes      | -             | Information about the HTTP service for sending authentication requests |\n| `timeout`                | int       | No       | 1000          | Connection timeout for `ext-auth` service, in milliseconds |\n| `authorization_request`  | object    | No       | -             | Configuration for sending authentication requests |\n| `authorization_response` | object    | No       | -             | Configuration for processing authentication responses |\n\n### Configuration Fields for Each Item in `endpoint`\n| Name             | Data Type | Required               | Default Value | Description                                                                                                   |\n| ---------------- | --------- | ---------------------- | ------------- | ------------------------------------------------------------------------------------------------------------- |\n| `service_name`   | string    | Required               | -             | Input the name of the authorization service, in complete FQDN format, e.g., `ext-auth.dns` or `ext-auth.my-ns.svc.cluster.local` |\n| `service_port`   | int       | No                     | 80            | Input the port of the authorization service                                                                      |\n| `service_host`   | string    | No                     | -             | The Host header set when requesting the authorization service; remains the same as FQDN if not filled          |\n| `path_prefix`    | string    | Required when `endpoint_mode` is `envoy` |             | Request path prefix for the client when sending requests to the authorization service                          |\n| `request_method` | string    | No                     | GET           | HTTP Method for client requests to the authorization service when `endpoint_mode` is `forward_auth`            |\n| `path`           | string    | Required when `endpoint_mode` is `forward_auth` | -             | Request path for the client when sending requests to the authorization service                                   |\n\n### Configuration Fields for Each Item in `authorization_request`\n| Name                     | Data Type               | Required | Default Value | Description                                                                                                                                                            |\n| ------------------------ | ---------------------- | -------- | ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| `allowed_headers`        | array of StringMatcher | No       | -             | When set, client request headers with matching criteria will be added to the headers of the request to the authorization service. The `Authorization` HTTP header will be automatically included in the authorization service request, and if `endpoint_mode` is `forward_auth`, the original request path will be set to `X-Original-Uri` and the original request HTTP method will be set to `X-Original-Method`. |\n| `headers_to_add`         | `map[string]string`    | No       | -             | Sets the list of request headers to include in the authorization service request. Note that headers with the same name from the client will be overwritten.              |\n| `with_request_body`      | bool                   | No       | false         | Buffer the client request body and send it in the authentication request (does not take effect for HTTP Methods GET, OPTIONS, and HEAD)                               |\n| `max_request_body_bytes` | int                    | No       | 10MB          | Sets the maximum size of the client request body to keep in memory. When the client request body reaches the value set in this field, an HTTP 413 status code will be returned, and the authorization process will not start. Note that this setting takes precedence over the `failure_mode_allow` configuration. |\n\n### Configuration Fields for Each Item in `authorization_response`\n| Name                       | Data Type               | Required | Default Value | Description                                                                                     |\n| -------------------------- | ---------------------- | -------- | ------------- | ----------------------------------------------------------------------------------------------- |\n| `allowed_upstream_headers` | array of StringMatcher | No       | -             | When set, the response headers of the authorization request with matching criteria will be added to the original client request headers. Note that headers with the same name will be overwritten. |\n| `allowed_client_headers`   | array of StringMatcher | No       | -             | If not set, all response headers from authorization requests will be added to the client\u2019s response when a request is denied. When set, response headers from authorization requests with matching criteria will be added to the client\'s response when a request is denied. |\n\n### Field Descriptions for `StringMatcher` Type\nWhen using `array of StringMatcher`, the fields are configured according to the order defined in the array.\n| Name       | Data Type | Required                                            | Default Value | Description |\n| ---------- | --------- | --------------------------------------------------- | ------------- | ----------- |\n| `exact`    | string    | No, must select one from `exact`, `prefix`, `suffix`, `contains`, `regex` | -             | Exact match |\n| `prefix`   | string    | No, must select one from `exact`, `prefix`, `suffix`, `contains`, `regex` | -             | Prefix match |\n| `suffix`   | string    | No, must select one from `exact`, `prefix`, `suffix`, `contains`, `regex` | -             | Suffix match |\n| `contains` | string    | No, must select one from `exact`, `prefix`, `suffix`, `contains`, `regex` | -             | Contains match |\n| `regex`    | string    | No, must select one from `exact`, `prefix`, `suffix`, `contains`, `regex` | -             | Regex match |\n\n## Configuration Example\nAssuming the `ext-auth` service has a serviceName of `ext-auth`, port `8090`, path `/auth`, and namespace `backend` in Kubernetes.\n\nTwo types of `endpoint_mode` are supported:\n- When `endpoint_mode` is `envoy`, the authentication request will use the original request HTTP Method, and the configured `path_prefix` will be concatenated with the original request path.\n- When `endpoint_mode` is `forward_auth`, the authentication request will use the configured `request_method` as the HTTP Method and the configured `path` as the request path.\n\n### Example 1: `endpoint_mode` is `envoy`\n#### Configuration of `ext-auth` Plugin:\n```yaml\nhttp_service:\n  endpoint_mode: envoy\n  endpoint:\n    service_name: ext-auth.backend.svc.cluster.local\n    service_port: 8090\n    path_prefix: /auth\n  timeout: 1000\n```\n\nUsing the following request to the gateway, after enabling the `ext-auth` plugin:\n```shell\ncurl -X POST http://localhost:8082/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 -X GET -H "foo: bar" -H "Authorization: xxx"\n```\n\n**Successful request to the `ext-auth` service:**\nThe `ext-auth` service will receive the following authentication request:\n```\nPOST /auth/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 HTTP/1.1\nHost: ext-auth.backend.svc.cluster.local\nAuthorization: xxx\nContent-Length: 0\n```\n\n**Failed request to the `ext-auth` service:**\nWhen the `ext-auth` service responds with a 5xx error, the client will receive an HTTP response code of 403 along with all response headers returned by the `ext-auth` service.\n\nIf the `ext-auth` service returns `x-auth-version: 1.0` and `x-auth-failed: true` headers, these will be conveyed to the client:\n```\nHTTP/1.1 403 Forbidden\nx-auth-version: 1.0\nx-auth-failed: true\ndate: Tue, 16 Jul 2024 00:19:41 GMT\nserver: istio-envoy\ncontent-length: 0\n```\n\nWhen the `ext-auth` service is inaccessible or returns a status code of 5xx, the client request will be denied with the status code configured in `status_on_error`. When the `ext-auth` service returns other HTTP status codes, the client request will be denied with the returned status code. If `allowed_client_headers` is configured, the matching response headers will be added to the client\'s response.\n\n#### Example 2: `ext-auth` Plugin Configuration:\n```yaml\nhttp_service:\n  authorization_request:\n    allowed_headers:\n    - exact: x-auth-version\n    headers_to_add:\n      x-envoy-header: true\n  authorization_response:\n    allowed_upstream_headers:\n    - exact: x-user-id\n    - exact: x-auth-version\n  endpoint_mode: envoy\n  endpoint:\n    service_name: ext-auth.backend.svc.cluster.local\n    service_host: my-domain.local\n    service_port: 8090\n    path_prefix: /auth\n  timeout: 1000\n```\n\nUsing the following request to the gateway after enabling the `ext-auth` plugin:\n```shell\ncurl -X POST http://localhost:8082/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 -X GET -H "foo: bar" -H "Authorization: xxx"\n```\n\nThe `ext-auth` service will receive the following authentication request:\n```\nPOST /auth/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 HTTP/1.1\nHost: my-domain.local\nAuthorization: xxx\nX-Auth-Version: 1.0\nx-envoy-header: true\nContent-Length: 0\n```\n\nIf the `ext-auth` service returns headers containing `x-user-id` and `x-auth-version`, these two request headers will be included in requests to the upstream when the gateway calls it.\n\n### Example 1: `endpoint_mode` is `forward_auth`\n`ext-auth` Plugin Configuration:\n```yaml\nhttp_service:\n  endpoint_mode: forward_auth\n  endpoint:\n    service_name: ext-auth.backend.svc.cluster.local\n    service_port: 8090\n    path: /auth\n    request_method: POST\n  timeout: 1000\n```\n\nUsing the following request to the gateway after enabling the `ext-auth` plugin:\n```shell\ncurl -i http://localhost:8082/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 -X GET -H "foo: bar" -H "Authorization: xxx"\n```\n\n**Successful request to the `ext-auth` service:**\nThe `ext-auth` service will receive the following authentication request:\n```\nPOST /auth HTTP/1.1\nHost: ext-auth.backend.svc.cluster.local\nAuthorization: xxx\nX-Original-Uri: /users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5\nX-Original-Method: GET\nContent-Length: 0\n```\n\n**Failed request to the `ext-auth` service:**\nWhen the `ext-auth` service responds with a 5xx error, the client will receive an HTTP response code of 403 along with all response headers returned by the `ext-auth` service.\n\nIf the `ext-auth` service returns `x-auth-version: 1.0` and `x-auth-failed: true` headers, these will be conveyed to the client:\n```\nHTTP/1.1 403 Forbidden\nx-auth-version: 1.0\nx-auth-failed: true\ndate: Tue, 16 Jul 2024 00:19:41 GMT\nserver: istio-envoy\ncontent-length: 0\n```\n\nWhen the `ext-auth` service is inaccessible or returns a status code of 5xx, the client request will be denied with the status code configured in `status_on_error`. When the `ext-auth` service returns other HTTP status codes, the client request will be denied with the returned status code. If `allowed_client_headers` is configured, the matching response headers will be added to the client\'s response.\n\n#### Example 2: `ext-auth` Plugin Configuration:\n```yaml\nhttp_service:\n  authorization_request:\n    allowed_headers:\n    - exact: x-auth-version\n    headers_to_add:\n      x-envoy-header: true\n  authorization_response:\n    allowed_upstream_headers:\n    - exact: x-user-id\n    - exact: x-auth-version\n  endpoint_mode: forward_auth\n  endpoint:\n    service_name: ext-auth.backend.svc.cluster.local\n    service_host: my-domain.local\n    service_port: 8090\n    path: /auth\n    request_method: POST\n  timeout: 1000\n```\n\nUsing the following request to the gateway after enabling the `ext-auth` plugin:\n```shell\ncurl -i http://localhost:8082/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 -X GET -H "foo: bar" -H "Authorization: xxx" -H "X-Auth-Version: 1.0"\n```\n\nThe `ext-auth` service will receive the following authentication request:\n```\nPOST /auth HTTP/1.1\nHost: my-domain.local\nAuthorization: xxx\nX-Original-Uri: /users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5\nX-Original-Method: GET\nX-Auth-Version: 1.0\nx-envoy-header: true\nContent-Length: 0\n```\n\nIf the `ext-auth` service returns headers containing `x-user-id` and `x-auth-version`, these two request headers will be included in requests to the upstream when the gateway calls it.\n\n#### x-forwarded-* Header\nWhen `endpoint_mode` is `forward_auth`, Higress will automatically generate and send the following headers to the authorization service.\n| Header             | Description                                   |\n|--------------------|-----------------------------------------------|\n| x-forwarded-proto  | The scheme of the original request, e.g., http/https |\n| x-forwarded-method | The method of the original request, e.g., get/post/delete/patch |\n| x-forwarded-host   | The host of the original request               |\n| x-forwarded-uri    | The path of the original request, including path parameters, e.g., /v1/app?test=true |\n| x-forwarded-for    | The client IP address of the original request   |\n',a={title:"External Authentication",description:"The Ext Authentication plugin implements the capability to call external authorization services for authentication and authorization.",editUrl:!0,head:[],template:"doc",sidebar:{hidden:!1,attrs:{}},pagefind:!0,keywords:["higress","auth"]},o={type:"content",filePath:"/home/runner/work/higress-group.github.io/higress-group.github.io/src/content/docs/latest/en/plugins/authentication/ext-auth.md",rawData:void 0};export{o as _internal,i as body,t as collection,a as data,e as id,n as slug};
