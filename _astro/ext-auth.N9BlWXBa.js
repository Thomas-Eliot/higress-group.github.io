const e="latest/en/plugins/authentication/ext-auth.md",t="docs",n="latest/en/plugins/authentication/ext-auth",a="\n## Feature Description\n\nThe `ext-auth` plugin sends an authorization request to an external authorization service to check if the client request is authorized. When implementing this plugin, it refers to the native [ext_authz filter](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/ext_authz_filter) of Envoy, and realizes part of the capabilities of the native filter to connect to an HTTP service.\n\n## Operating Attributes\n\nPlugin Execution Phase: `Authentication Phase`\nPlugin Execution Priority: `360`\n\n\n## Configuration Fields\n\n| Name | Data Type | Required | Default Value | Description |\n| --- | --- | --- | --- | --- |\n| `http_service` | object | Yes | - | Configuration for the external authorization service |\n| `match_type` | string | No |  | Can be `whitelist` or `blacklist` |\n| `match_list` | array of MatchRule | No |  | A list containing (`match_rule_domain`, `match_rule_path`, `match_rule_type`) |\n| `failure_mode_allow` | bool | No | false | When set to true, client requests will be accepted even if the communication with the authorization service fails or the authorization service returns an HTTP 5xx error |\n| `failure_mode_allow_header_add` | bool | No | false | When both `failure_mode_allow` and `failure_mode_allow_header_add` are set to true, if the communication with the authorization service fails or the authorization service returns an HTTP 5xx error, the `x-envoy-auth-failure-mode-allowed: true` header will be added to the request header |\n| `status_on_error` | int | No | 403 | Sets the HTTP status code returned to the client when the authorization service is inaccessible or has a 5xx status code. The default status code is `403` |\n\nConfiguration fields for each item in `http_service`\n\n| Name | Data Type | Required | Default Value | Description |\n| --- | --- | --- | --- | --- |\n| `endpoint_mode` | string | No | envoy | Can be `envoy` or `forward_auth` |\n| `endpoint` | object | Yes | - | Information about the HTTP service to which the authentication request is sent |\n| `timeout` | int | No | 1000 | The connection timeout for the `ext-auth` service in milliseconds |\n| `authorization_request` | object | No | - | Configuration for sending the authentication request |\n| `authorization_response` | object | No | - | Configuration for handling the authentication response |\n\nConfiguration fields for each item in `endpoint`\n\n| Name | Data Type | Required | Default Value | Description |\n| --- | --- | --- | --- | --- |\n| `service_name` | string | Yes | - | Enter the name of the authorization service, the full FQDN name with service type, e.g., `ext-auth.dns`, `ext-auth.my-ns.svc.cluster.local` |\n| `service_port` | int | No | 80 | Enter the service port of the authorization service |\n| `service_host` | string | No | - | The Host header set when requesting the authorization service. If not filled, it will be the same as the FQDN |\n| `path_prefix` | string | Required when `endpoint_mode` is `envoy` | - | When `endpoint_mode` is `envoy`, the request path prefix for the client to send a request to the authorization service |\n| `request_method` | string | No | GET | When `endpoint_mode` is `forward_auth`, the HTTP Method for the client to send a request to the authorization service |\n| `path` | string | Required when `endpoint_mode` is `forward_auth` | - | When `endpoint_mode` is `forward_auth`, the request path for the client to send a request to the authorization service |\n\nConfiguration fields for each item in `authorization_request`\n\n| Name | Data Type | Required | Default Value | Description |\n| --- | --- | --- | --- | --- |\n| `allowed_headers` | array of StringMatcher | No | - | After setting, the client request headers that match the items will be added to the request headers in the authorization service request. In addition to the user-defined header matching rules, the `Authorization` HTTP header will be automatically included in the authorization service request (when `endpoint_mode` is `forward_auth`, the `X-Forwarded-*` request headers will be added) |\n| `headers_to_add` | map[string]string | No | - | Sets the list of request headers to be included in the authorization service request. Please note that the client request headers with the same name will be overwritten |\n| `with_request_body` | bool | No | false | Buffer the client request body and send it to the authentication request (not effective for HTTP Method GET, OPTIONS, HEAD requests) |\n| `max_request_body_bytes` | int | No | 10MB | Sets the maximum size of the client request body to be saved in memory. When the client request body reaches the value set in this field, an HTTP 413 status code will be returned and the authorization process will not be started. Note that this setting takes precedence over the `failure_mode_allow` configuration |\n\nConfiguration fields for each item in `authorization_response`\n\n| Name | Data Type | Required | Default Value | Description |\n| --- | --- | --- | --- | --- |\n| `allowed_upstream_headers` | array of StringMatcher | No | - | The response headers of the authentication request that match the items will be added to the original client request headers. Please note that the request headers with the same name will be overwritten |\n| `allowed_client_headers` | array of StringMatcher | No | - | If not set, when the request is rejected, all the response headers of the authentication request will be added to the client's response headers. When set, when the request is rejected, the response headers of the authentication request that match the items will be added to the client's response headers |\n\nConfiguration fields for each item of `StringMatcher` type. When using `array of StringMatcher`, the StringMatchers defined in the array will be configured in order.\n\n| Name | Data Type | Required | Default Value | Description |\n| --- | --- | --- | --- | --- |\n| `exact` | string | No, one of `exact`, `prefix`, `suffix`, `contains`, `regex` must be selected | - | Exact match |\n| `prefix` | string | No, one of `exact`, `prefix`, `suffix`, `contains`, `regex` must be selected | - | Prefix match |\n| `suffix` | string | No, one of `exact`, `prefix`, `suffix`, `contains`, `regex` must be selected | - | Suffix match |\n| `contains` | string | No, one of `exact`, `prefix`, `suffix`, `contains`, `regex` must be selected | - | Contains |\n| `regex` | string | No, one of `exact`, `prefix`, `suffix`, `contains`, `regex` must be selected | - | Regular expression match |\n\nConfiguration fields for each item of `MatchRule` type. When using `array of MatchRule`, the MatchRules defined in the array will be configured in order.\n\n| Name | Data Type | Required | Default Value | Description |\n| --- | --- | --- | --- | --- |\n| `match_rule_domain` | string | No | - | The domain of the matching rule, supports wildcard patterns, e.g., `*.bar.com` |\n| `match_rule_method` | []string | No | - | Matching rule for the request method |\n| `match_rule_path` | string | No | - | The rule for matching the request path |\n| `match_rule_type` | string | No | - | The type of the rule for matching the request path, can be `exact`, `prefix`, `suffix`, `contains`, `regex` |\n\n### Differences between the two `endpoint_mode`\n\nWhen `endpoint_mode` is `envoy`, the authentication request will use the original request's HTTP Method and the configured `path_prefix` as the request path prefix, concatenated with the original request path.\n\nWhen `endpoint_mode` is `forward_auth`, the authentication request will use the configured `request_method` as the HTTP Method and the configured `path` as the request path. Higress will automatically generate and send the following headers to the authorization service:\n\n| Header | Description |\n| --- | --- |\n| `x-forwarded-proto` | The scheme of the original request, such as http/https |\n| `x-forwarded-method` | The method of the original request, such as get/post/delete/patch |\n| `x-forwarded-host` | The host of the original request |\n| `x-forwarded-uri` | The path of the original request, including path parameters, e.g., `/v1/app?test=true` |\n\n### Blacklist and Whitelist Modes\n\nSupports blacklist and whitelist mode configuration. The default is the whitelist mode. If the whitelist is empty, all requests need to be verified. The matching domain supports wildcard domains such as `*.bar.com`, and the matching rule supports `exact`, `prefix`, `suffix`, `contains`, `regex`.\n\n**Whitelist Mode**\n\n```yaml\n# Configuration for the whitelist mode. Requests that match the whitelist rules do not need verification.\nmatch_type: 'whitelist'\nmatch_list:\n  # Requests with the domain name api.example.com and a path prefixed with /public do not need verification.\n  - match_rule_domain: 'api.example.com'\n    match_rule_path: '/public'\n    match_rule_type: 'prefix'\n  # For the image resource server images.example.com, all GET requests do not need verification.\n  - match_rule_domain: 'images.example.com'\n    match_rule_method: [\"GET\"]\n  # For all domains, HEAD requests with an exact path match of /health-check do not need verification.\n  - match_rule_method: [\"HEAD\"]\n    match_rule_path: '/health-check'\n    match_rule_type: 'exact'\n```\n\n**Blacklist Mode**\n\n```yaml\n# Configuration for the blacklist mode. Requests that match the blacklist rules need verification.\nmatch_type: 'blacklist'\nmatch_list:\n  # Requests with the domain name admin.example.com and a path prefixed with /sensitive need verification.\n  - match_rule_domain: 'admin.example.com'\n    match_rule_path: '/sensitive'\n    match_rule_type: 'prefix'\n  # For all domains, DELETE requests with an exact path match of /user need verification.\n  - match_rule_method: [\"DELETE\"]\n    match_rule_path: '/user'\n    match_rule_type: 'exact'\n  # For the domain legacy.example.com, all POST requests need verification.\n  - match_rule_domain: 'legacy.example.com'\n    match_rule_method: [\"POST\"]\n```\n\n\n## Configuration Examples\n\nAssume that in Kubernetes, the `ext-auth` service has a `serviceName` of `ext-auth`, a port of `8090`, a path of `/auth`, and is in the `backend` namespace.\n\n### When endpoint_mode is envoy\n\n#### Example 1\n\nConfiguration of the `ext-auth` plugin:\n\n```yaml\nhttp_service:\n  endpoint_mode: envoy\n  endpoint:\n    service_name: ext-auth.backend.svc.cluster.local\n    service_port: 8090\n    path_prefix: /auth\n  timeout: 1000\n```\n\nWhen using the following request to the gateway after enabling the `ext-auth` plugin:\n\n```shell\ncurl -X POST http://localhost:8082/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 -X GET -H \"foo: bar\" -H \"Authorization: xxx\"\n```\n\n**When the request to the `ext-auth` service is successful**:\n\nThe `ext-auth` service will receive the following authorization request:\n\n```\nPOST /auth/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 HTTP/1.1\nHost: ext-auth.backend.svc.cluster.local\nAuthorization: xxx\nContent-Length: 0\n```\n\n**When the request to the `ext-auth` service fails**:\n\nWhen the response from the `ext-auth` service is 5xx, the client will receive an HTTP response code of 403 and all the response headers returned by the `ext-auth` service.\n\nIf the `ext-auth` service returns response headers of `x-auth-version: 1.0` and `x-auth-failed: true`, they will be passed to the client.\n\n```\nHTTP/1.1 403 Forbidden\nx-auth-version: 1.0\nx-auth-failed: true\ndate: Tue, 16 Jul 2024 00:19:41 GMT\nserver: istio-envoy\ncontent-length: 0\n```\n\nWhen the `ext-auth` service is inaccessible or the status code is 5xx, the client request will be rejected with the status code configured in `status_on_error`.\n\nWhen the `ext-auth` service returns other HTTP status codes, the client request will be rejected with the returned status code. If `allowed_client_headers` is configured, the response headers with corresponding matching items will be added to the client's response.\n\n#### Example 2\n\nConfiguration of the `ext-auth` plugin:\n\n```yaml\nhttp_service:\n  authorization_request:\n    allowed_headers:\n      - exact: x-auth-version\n    headers_to_add:\n      x-envoy-header: true\n  authorization_response:\n    allowed_upstream_headers:\n      - exact: x-user-id\n      - exact: x-auth-version\n  endpoint_mode: envoy\n  endpoint:\n    service_name: ext-auth.backend.svc.cluster.local\n    service_host: my-domain.local\n    service_port: 8090\n    path_prefix: /auth\n  timeout: 1000\n```\n\nWhen using the following request to the gateway after enabling the `ext-auth` plugin:\n\n```shell\ncurl -X POST http://localhost:8082/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 -X GET -H \"foo: bar\" -H \"Authorization: xxx\"\n```\n\nThe `ext-auth` service will receive the following authorization request:\n\n```\nPOST /auth/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 HTTP/1.1\nHost: my-domain.local\nAuthorization: xxx\nX-Auth-Version: 1.0\nx-envoy-header: true\nContent-Length: 0\n```\n\nIf the response headers returned by the `ext-auth` service contain `x-user-id` and `x-auth-version`, these two headers will be included in the request when the gateway calls the upstream.\n\n### When endpoint_mode is forward_auth\n\n#### Example 1\n\nConfiguration of the `ext-auth` plugin:\n\n```yaml\nhttp_service:\n  endpoint_mode: forward_auth\n  endpoint:\n    service_name: ext-auth.backend.svc.cluster.local\n    service_port: 8090\n    path: /auth\n    request_method: POST\n  timeout: 1000\n```\n\nWhen using the following request to the gateway after enabling the `ext-auth` plugin:\n\n```shell\ncurl -i http://localhost:8082/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 -X GET -H \"foo: bar\" -H \"Authorization: xxx\" -H \"Host: foo.bar.com\"\n```\n\n**When the request to the `ext-auth` service is successful**:\n\nThe `ext-auth` service will receive the following authorization request:\n\n```\nPOST /auth HTTP/1.1\nHost: ext-auth.backend.svc.cluster.local\nAuthorization: xxx\nX-Forwarded-Proto: HTTP\nX-Forwarded-Host: foo.bar.com\nX-Forwarded-Uri: /users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5\nX-Forwarded-Method: GET\nContent-Length: 0\n```\n\n**When the request to the `ext-auth` service fails**:\n\nWhen the response from the `ext-auth` service is 5xx, the client will receive an HTTP response code of 403 and all the response headers returned by the `ext-auth` service.\n\nIf the `ext-auth` service returns response headers of `x-auth-version: 1.0` and `x-auth-failed: true`, they will be passed to the client.\n\n```\nHTTP/1.1 403 Forbidden\nx-auth-version: 1.0\nx-auth-failed: true\ndate: Tue, 16 Jul 2024 00:19:41 GMT\nserver: istio-envoy\ncontent-length: 0\n```\n\nWhen the `ext-auth` service is inaccessible or the status code is 5xx, the client request will be rejected with the status code configured in `status_on_error`.\n\nWhen the `ext-auth` service returns other HTTP status codes, the client request will be rejected with the returned status code. If `allowed_client_headers` is configured, the response headers with corresponding matching items will be added to the client's response.\n\n#### Example 2\n\nConfiguration of the `ext-auth` plugin:\n\n```yaml\nhttp_service:\n  authorization_request:\n    allowed_headers:\n      - exact: x-auth-version\n    headers_to_add:\n      x-envoy-header: true\n  authorization_response:\n    allowed_upstream_headers:\n      - exact: x-user-id\n      - exact: x-auth-version\n  endpoint_mode: forward_auth\n  endpoint:\n    service_name: ext-auth.backend.svc.cluster.local\n    service_host: my-domain.local\n    service_port: 8090\n    path: /auth\n    request_method: POST\n  timeout: 1000\n```\n\nWhen using the following request to the gateway after enabling the `ext-auth` plugin:\n\n```shell\ncurl -i http://localhost:8082/users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5 -X GET -H \"foo: bar\" -H \"Authorization: xxx\" -H \"X-Auth-Version: 1.0\" -H \"Host: foo.bar.com\"\n```\n\nThe `ext-auth` service will receive the following authorization request:\n\n```\nPOST /auth HTTP/1.1\nHost: my-domain.local\nAuthorization: xxx\nX-Forwarded-Proto: HTTP\nX-Forwarded-Host: foo.bar.com\nX-Forwarded-Uri: /users?apikey=9a342114-ba8a-11ec-b1bf-00163e1250b5\nX-Forwarded-Method: GET\nX-Auth-Version: 1.0\nx-envoy-header: true\nContent-Length: 0\n```\n\nIf the response headers returned by the `ext-auth` service contain `x-user-id` and `x-auth-version`, these two headers will be included in the request when the gateway calls the upstream.",i={title:"External Authentication",description:"The Ext Authentication plugin implements the capability to call external authorization services for authentication and authorization.",editUrl:!0,head:[],template:"doc",sidebar:{hidden:!1,attrs:{}},pagefind:!0,keywords:["higress","auth"]},o={type:"content",filePath:"/home/runner/work/higress-group.github.io/higress-group.github.io/src/content/docs/latest/en/plugins/authentication/ext-auth.md",rawData:void 0};export{o as _internal,a as body,t as collection,i as data,e as id,n as slug};
