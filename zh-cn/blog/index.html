<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Blog | Higress</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://higress.io/zh-cn/img/higress_logo_small.png"><meta data-rh="true" name="twitter:image" content="https://higress.io/zh-cn/img/higress_logo_small.png"><meta data-rh="true" property="og:url" content="https://higress.io/zh-cn/blog"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="keywords" content="higress,higress官网,云原生网关"><meta data-rh="true" name="baidu-site-verification" content="codeva-T2MeTQHYnM"><meta data-rh="true" property="og:title" content="Blog | Higress"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/zh-cn/img/higress_logo_small.png"><link data-rh="true" rel="canonical" href="https://higress.io/zh-cn/blog"><link data-rh="true" rel="alternate" href="https://higress.io/en-us/blog" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://higress.io/zh-cn/blog" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://higress.io/blog" hreflang="default"><link data-rh="true" rel="alternate" href="https://higress.io/blog" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zh-cn/blog/rss.xml" title="Higress RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-cn/blog/atom.xml" title="Higress Atom Feed">






<link rel="stylesheet" href="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.css">
<script src="//g.alicdn.com/mamba/assets/0.0.19/mse-arc-ui.min.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-YHS75WKFBR" async></script><link rel="stylesheet" href="/zh-cn/assets/css/styles.69857bcd.css">
<link rel="preload" href="/zh-cn/assets/js/runtime~main.eafa2191.js" as="script">
<link rel="preload" href="/zh-cn/assets/js/main.52b6581f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-cn/"><div class="navbar__logo"><img src="//img.alicdn.com/imgextra/i1/O1CN01I7WjVs1K33EQjInid_!!6000000001107-2-tps-960-290.png" alt="Higress logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="//img.alicdn.com/imgextra/i1/O1CN01I7WjVs1K33EQjInid_!!6000000001107-2-tps-960-290.png" alt="Higress logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-cn/">首页</a><a class="navbar__item navbar__link" href="/zh-cn/docs/overview/what-is-higress">文档</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Higress 企业版</a><ul class="dropdown__menu"><li><a href="https://www.aliyun.com/product/aliware/mse?spm=higress-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">企业版说明</a></li><li><a href="https://free.aliyun.com/?searchKey=云原生网关&amp;spm=higress-website.topbar.0.0.0" target="_blank" rel="noopener noreferrer" class="dropdown__link">免费试用</a></li></ul></div><a href="https://survey.aliyun.com/apps/zhiliao/SmDQwdihe" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">案例征集</a><a class="navbar__item navbar__link" href="/zh-cn/docs/developers/developers_dev">开发者</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-cn/blog">博客</a><a class="navbar__item navbar__link" href="/zh-cn/community">社区</a><a href="https://github.com/alibaba/higress/releases" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">下载</a><a href="http://demo.higress.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">控制台样例</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中</a><ul class="dropdown__menu"><li><a href="/en-us/blog" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">En</a></li><li><a href="/zh-cn/blog" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/qwen-or-chatgpt">通义千问2.5“客串”ChatGPT4，你分的清吗</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/pilot-debug">教程：如何在本地开发和调试 Higress Pilot</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/console-dev">教程：如何在本地开发和调试 Higress 控制台</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/admin-sdk-intro">如何使用 Higress Admin SDK 进行配置管理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/higress-code">higress-core源码分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/e2e-debug">教程：如何在本地进行higress调试和端到端测试</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/hring">Higress 团队招募小伙伴加入～</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/release-1.3">Higress 开源一周年：新版本，新标准，新工具，新征程</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/plugin-transformer">通过 Higress Wasm 插件 3 倍性能实现 Spring-cloud-gateway 功能</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/2023-kubecon">Higress在2023 KubeCon China的分享</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/config-with-file">基于文件配置实现 Higress 极简独立部署</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/DeployOnWindows">Windows 下 Higress 部署实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/configmap">Higress 全局配置控制面原理分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/ai_plugin">Higress助力AI大模型企业级应用落地</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/user-mq">美洽智能客服使用 Higress 统一网关落地实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/skywalking">Higress 集成 Skywalking 可观测性探索</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/ospp-2023">Higress 开源之夏项目报名</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/release-100">上线控制台，降低使用门槛 ｜ Higress 1.0.0 RC 版本发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/user-uu">UU跑腿基于Higress的云原生网关实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/release-070">Higress 0.7.0 版本发布：GA 进入倒计时</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/nacos">Higress + Nacos 微服务网关最佳实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/30-line-wasm">30行代码写一个Wasm Go插件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/first-meetup">欢迎报名Higress首次线下Meetup</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/zh-cn/blog/higress">阿里巴巴重磅开源云原生网关</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="基于通义千问大模型，使用 Higress 和 NextChat 搭建跨平台的私人 ChatGPT 应用"><meta itemprop="keywords" content="Higress,Wasm,AI,Qwen,ChatGPT,NextChat"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/qwen-or-chatgpt">通义千问2.5“客串”ChatGPT4，你分的清吗</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-05-11T00:00:00.000Z" itemprop="datePublished">2024年5月11日</time> · <!-- -->阅读需 10 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">CH3CHO、澄潭</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="引子">引子<a href="#引子" class="hash-link" aria-label="引子的直接链接" title="引子的直接链接">​</a></h2><p>OpenAI 发布了最新的 GPT-4o 模型，通义千问也在前不久刚发布通义千问 2.5，已经和 GPT-4-Turbo 不分伯仲：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN0148JrOd21va23GzrEb_!!6000000007047-0-tps-1080-813.jpg" class="img_ev3q"></p><p>既然目前还没有和 GPT-4o 文本生成能力的对比数据，就让我们来和大模型一起做个游戏测试一下：</p><blockquote><p>我们让通义千问 2.5 扮演 GPT4，来和真正的 GPT4 进行问答 PK，读者不妨来猜一猜谁是通义千问。</p><p>两名选手的头像和昵称分别是：</p><p>🌝 ：我是GPT4</p><p>🌚 ：如假包换GPT4</p></blockquote><p>谁是通义千问，谁是ChatGPT，答案将在文末揭晓。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="round-1">Round 1<a href="#round-1" class="hash-link" aria-label="Round 1的直接链接" title="Round 1的直接链接">​</a></h2><p>第一轮由“我是GPT4”选手提问，由“如假包换GPT4”选手作答</p><p>🌝：角色设定+第一个问题</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01RXt7bg1Pl5YpGvDHW_!!6000000001880-2-tps-855-480.png" alt="QA" class="img_ev3q"></p><p>🌚 ：角色设定+第一个回答</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01UOHsOZ1tFt3GPBsRr_!!6000000005873-2-tps-855-422.png" alt="QA" class="img_ev3q"></p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01LJQ5zW1IOv4xlYt6k_!!6000000000884-2-tps-855-525.png" alt="QA" class="img_ev3q"></p><p>🌝 ：第二个问题</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01h0fgCS1WNupcRJqr3_!!6000000002777-2-tps-860-411.png" alt="QA" class="img_ev3q"></p><p>🌚 ：第二个回答</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01h4Oqhu1EeFsSfNVXZ_!!6000000000376-2-tps-855-507.png" alt="QA" class="img_ev3q"></p><p>🌝 ：第三个问题</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01iD3xp32AAFe6pUMTY_!!6000000008162-2-tps-860-374.png" alt="QA" class="img_ev3q"></p><p>🌚 ：第三个回答</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01yDu0m41r9oZFojWHF_!!6000000005589-2-tps-855-433.png" alt="QA" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="round-2">Round 2<a href="#round-2" class="hash-link" aria-label="Round 2的直接链接" title="Round 2的直接链接">​</a></h2><p>第二轮由“如假包换GPT4”选手提问，由“我是GPT4”选手作答</p><p>🌚 ：角色设定+第一个问题</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01v1PrMd1HrwYtq3N7x_!!6000000000812-2-tps-855-517.png" alt="QA" class="img_ev3q"></p><p>🌝 ：角色设定+第一个回答</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i4/O1CN01Jm4Ke81CjAtwWAz9g_!!6000000000116-2-tps-855-422.png" alt="QA" class="img_ev3q"></p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01CNkl9B1la1XSUOJIG_!!6000000004834-2-tps-855-441.png" alt="QA" class="img_ev3q"></p><p>🌚 ：第二个问题</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01lD1DTl1FgpitHnhmI_!!6000000000517-2-tps-860-353.png" alt="QA" class="img_ev3q"></p><p>🌝 ：第二个回答</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01v8g20421HjZh3EtET_!!6000000006960-2-tps-855-517.png" alt="QA" class="img_ev3q"></p><p>🌚 ：第三个问题</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01Dbl4ub1UacaQ6vBlT_!!6000000002534-2-tps-860-353.png" alt="QA" class="img_ev3q"></p><p>🌝 ：第三个回答</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i2/O1CN01jDt0gk1SnKLN6Ay8W_!!6000000002291-2-tps-855-749.png" alt="QA" class="img_ev3q"></p><p>🌚 的回答更简短，更符合设定的要求，也是因为 🌝 的提问根据给定的要求更聚焦，相比下 🌚 的问题更发散，且都包含子问题，比较难用一两句话来作答。整体来说确实不分伯仲。</p><p>不过，聪明的你，可能已经有了答案。如果急于验证，可以直接划到文末查看。如果你对上面通义千问是如何扮演 ChatGPT，以及聊天框工具感到好奇，不妨先来看我们是如何搭建这个测试场景的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试场景介绍">测试场景介绍<a href="#测试场景介绍" class="hash-link" aria-label="测试场景介绍的直接链接" title="测试场景介绍的直接链接">​</a></h2><p>我们使用了两个开源软件工具来搭建：<strong>NextChat</strong> 和 <strong>Higress</strong>。</p><p><a href="https://github.com/ChatGPTNextWeb/ChatGPT-Next-Web" target="_blank" rel="noopener noreferrer">NextChat (ChatGPT Next Web)</a> 是一个可以私有化部署的开源 ChatGPT 网页应用，目前支持对接 OpenAI、Azure OpenAI、Google Gemini Pro 和 Anthropic Claude 这些 LLM 服务提供商。</p><p><a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">Higress</a> 是阿里云开源的高集成、易使用、易扩展、热更新的云原生API网关，遵循开源 Ingress/Gateway API 标准，提供流量调度、服务治理、安全防护三合一的网关能力。</p><p>我们使用 NextChat 来搭建前端，并使用 Higress 将通义千问的应答转换为 OpenAI 协议返回给 NextChat。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="具体搭建步骤">具体搭建步骤：<a href="#具体搭建步骤" class="hash-link" aria-label="具体搭建步骤：的直接链接" title="具体搭建步骤：的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="第一步启动容器">第一步：启动容器<a href="#第一步启动容器" class="hash-link" aria-label="第一步：启动容器的直接链接" title="第一步：启动容器的直接链接">​</a></h4><p>完整的 docker compose 配置贴在 Higress 社区的这个 <a href="https://github.com/alibaba/higress/issues/938" target="_blank" rel="noopener noreferrer">issue</a> 中。</p><blockquote><p><strong>注意：</strong></p><p>Higress 容器环境变量中的 <code>YOUR_DASHSCOPE_API_KEY</code> 需要替换为你自己的<a href="https://help.aliyun.com/zh/dashscope/opening-service?spm=a2c4g.11186623.0.0.72c2369dLprd45" target="_blank" rel="noopener noreferrer">通义千问的 API Key</a>。</p></blockquote><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> compose -p higress-ai up -d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="第二步在浏览器里访问-httplocalhost3000打开-nextchat-页面">第二步：在浏览器里访问 http://localhost:3000/，打开 NextChat 页面；<a href="#第二步在浏览器里访问-httplocalhost3000打开-nextchat-页面" class="hash-link" aria-label="第二步：在浏览器里访问 http://localhost:3000/，打开 NextChat 页面；的直接链接" title="第二步：在浏览器里访问 http://localhost:3000/，打开 NextChat 页面；的直接链接">​</a></h4><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01gJKDHH1vg6xdW0Zei_!!6000000006201-2-tps-1913-1129.png" alt="image" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="第三步点击对话输入框工具栏最右侧的模型设置按钮切换模型">第三步：点击对话输入框工具栏最右侧的模型设置按钮，切换模型<a href="#第三步点击对话输入框工具栏最右侧的模型设置按钮切换模型" class="hash-link" aria-label="第三步：点击对话输入框工具栏最右侧的模型设置按钮，切换模型的直接链接" title="第三步：点击对话输入框工具栏最右侧的模型设置按钮，切换模型的直接链接">​</a></h4><p>因为 Higress 的 AI Proxy 插件（可以访问 http://localhost:8001 登录 Higress 的控制台查看插件配置）配置了 gpt-4o 到 qwen-max （即通义千问 2.5）的模型映射，所以实际上这里提供的模型服务是 qwen-max </p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01w8Zih920gdUdllSJS_!!6000000006879-0-tps-1150-1248.jpg" alt="image" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="完成现在你就可以与-ai-进行对话了">完成！现在你就可以与 AI 进行对话了。<a href="#完成现在你就可以与-ai-进行对话了" class="hash-link" aria-label="完成！现在你就可以与 AI 进行对话了。的直接链接" title="完成！现在你就可以与 AI 进行对话了。的直接链接">​</a></h4><p>可以看到 Higress 实现了流式的效果，这不仅基于 Higress 底层对 SSE 等流式协议的良好支持，也依赖 Higress 的 Wasm 插件扩展机制可以实现通义千问协议到 OpenAI 协议的流式转换</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i3/O1CN01VBt9mC1SYffZ7gbPY_!!6000000002259-1-tps-900-1188.gif" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-ai-网关介绍">Higress AI 网关介绍<a href="#higress-ai-网关介绍" class="hash-link" aria-label="Higress AI 网关介绍的直接链接" title="Higress AI 网关介绍的直接链接">​</a></h2><p>随着 LLM 技术蓬勃发展，AI Web 应用创新如火如荼，对于构建一款 Web 应用来说，网关是必须的。而 AI Web 应用流量有以下特征，和对 AI 网关的需求：</p><ol><li>长连接：由 AI Web 应用常见的 Websocket 和 SSE 协议决定，长连接的比例很高，要求网关更新配置操作对长连接无影响，不影响业务</li><li>高延时：LLM 推理的响应延时比普通 Web 应用要高出很多，使得 AI Web 应用面向 CC 攻击很脆弱，容易被攻击长时间维持住大量长连接，消耗大量计算和存储资源</li><li>大带宽：结合 LLM 上下文来回传输，以及高延时的特性，AI Web 应用对带宽的消耗远超普通应用，网关或后端如果没有实现较好的流式处理能力，容易导致内存快速上涨，继而触发 OOM</li></ol><p>Higress 可以很好地解决这些痛点：</p><ol><li>长连接：不同于 Nginx 变更配置需要 Reload，导致连接断开，Higress 基于 Envoy 实现了连接无损的真正配置热更新</li><li>高延时：Higress 基于安全网关能力可以提供 CC 防护能力，并面向 AI 场景，除了 QPS，还可以扩展针对 Token 生成的限流防护</li><li>大带宽：Higress 支持完全流式转发，在 AI Web 应用场景下，所需的内存占用极低，同时也可以开发 Wasm 插件对请求和响应进行自定义逻辑的流式处理</li></ol><p>从上面的测试环境搭建流程来看，Higress AI 代理插件可以很方便的让 AI 对话应用直接对接通义千问等接口契约不同的大模型服务。除了通义千问和 ChatGPT 之外，这个插件还支持 Azure OpenAI 和月之暗面（Moonshot）等大模型服务提供商，并且支持配置一个外部文件地址作为聊天上下文，可以用来快速搭建一个个人 AI 助理服务。</p><p>整个插件使用 Go 语言进行开发，代码可以在这里找到：<a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/ai-proxy" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/ai-proxy</a></p><p>对于流式相应的处理方法，大家可以参考这段代码：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 这个 handler 函数会重入。在收到响应 body 的流式分块后，每次调用此函数会传入一个分块（chunk）。isLastChunk 标识是否是最后一个分块。方法处理完需要返回修改后的分块。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">onStreamingResponseBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx wrapper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HttpContext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pluginConfig config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chunk </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> isLastChunk </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> log wrapper</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activeProvider </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pluginConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> activeProvider </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;[onStreamingResponseBody] no active provider, skip processing&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> chunk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;[onStreamingResponseBody] provider=%s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> activeProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetProviderType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;isLastChunk=%v chunk: %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> isLastChunk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chunk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> activeProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamingResponseBodyHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        apiName </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctxKeyApiName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ApiName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        modifiedChunk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OnStreamingResponseBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> apiName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chunk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> isLastChunk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> modifiedChunk </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> modifiedChunk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> chunk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> chunk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有兴趣参与 Higress 社区贡献，实现更多大模型 API 的适配，可以到这个 issue 下认领任务：</p><p><a href="https://github.com/alibaba/higress/issues/940" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/issues/940</a></p><p>也欢迎参与 NextChat 社区贡献，参与到 3.0 版本的建设中：</p><p><a href="https://github.com/ChatGPTNextWeb/ChatGPT-Next-Web/issues/4622" target="_blank" rel="noopener noreferrer">https://github.com/ChatGPTNextWeb/ChatGPT-Next-Web/issues/4622</a></p><p>有任何使用问题，也欢迎到社区提 issue，也可以进微信或钉钉群交流：</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01LWh6QW1TxEWflxKVg_!!6000000002448-0-tps-720-405.jpg" class="img_ev3q"></p><p>此外，由中国科学院软件研究所“开源软件供应链点亮计划”发起并长期支持的暑期开源活动“开源之夏”正在进行中。Higress 也有两个与 AI 网关相关的项目参与其中，分别是“基于向量相似度实现LLM结果召回的WASM插件”和“基于AI网关实现AI模型的轻量化部署”。欢迎各位在校同学积极报名参与。</p><p>详情可查看开源之夏的 <a href="https://summer-ospp.ac.cn/org/orgdetail/1f8ea42c-86c9-46b8-b1f5-344de5741ef0" target="_blank" rel="noopener noreferrer">Higress 社区页面</a>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="答案揭晓">答案揭晓<a href="#答案揭晓" class="hash-link" aria-label="答案揭晓的直接链接" title="答案揭晓的直接链接">​</a></h2><p>最后，我们来揭晓前面问题的答案。不知道各位猜对了吗？</p><p><img loading="lazy" src="https://img.alicdn.com/imgextra/i1/O1CN01hVms8W1JleLluvbuJ_!!6000000001069-2-tps-860-338.png" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="介绍如何在本地开发和调试 Higress 中的 Pilot 组件"><meta itemprop="keywords" content="higress,pilot"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/pilot-debug">教程：如何在本地开发和调试 Higress Pilot</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-03-16T00:00:00.000Z" itemprop="datePublished">2024年3月16日</time> · <!-- -->阅读需 6 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">CH3CHO</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景说明">背景说明<a href="#背景说明" class="hash-link" aria-label="背景说明的直接链接" title="背景说明的直接链接">​</a></h2><p>前面 SJC 在<a href="/zh-cn/blog/e2e-debug">这篇博客</a>中介绍了如何在本地开发和调试 Higress Controller。而 Higress 控制面除了 Controller 之外还有一个组件，那就是 Pilot。本文就将介绍如何在本地开发和调试 Higress Pilot。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="环境准备">环境准备<a href="#环境准备" class="hash-link" aria-label="环境准备的直接链接" title="环境准备的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="步骤一克隆代码仓库">步骤一：克隆代码仓库<a href="#步骤一克隆代码仓库" class="hash-link" aria-label="步骤一：克隆代码仓库的直接链接" title="步骤一：克隆代码仓库的直接链接">​</a></h3><p>Pilot 的代码目前是以 Istio 上游仓库 submodule 加补丁文件的形式存在于 Higress 的主仓库中的，所以直接克隆 Higress 的代码主仓库 <a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress</a> 即可。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="步骤二准备项目代码">步骤二：准备项目代码<a href="#步骤二准备项目代码" class="hash-link" aria-label="步骤二：准备项目代码的直接链接" title="步骤二：准备项目代码的直接链接">​</a></h3><p>Higress Pilot 是在 Istio Pilot 的基础上，基于 Higress 自身的功能需求进行了二次开发而构建而成的，所以我们这里需要下载上游代码仓库并应用现有的补丁。我们只需要执行下面这条命令：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><span class="token plain"> prebuild</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Windows 用户注意了！</strong></p><p>如果你是在 Windows 上进行开发，并且执行 <code>make</code> 命令有困难的话，不要怕，我们也有办法。因为整个 prebuild 其实也只做了两件事情。</p><p>第一件事情是初始化所有的上游子模块，只需要执行这样一条命令：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> submodule update --init</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二件事情是初始化开发目录。这一步骤执行的就是 <code>tools/hack/prebuild.sh</code>。大家可以直接在 Cygwin 或者 Git Bash 等类 Linux 终端下执行这个脚本文件。</p><p>如果在应用补丁的时候出现了和换行符有关的报错，那么可以编辑 <code>prebuild.sh</code>，给两处 <code>patch</code> 命令增加 <code>--binary</code> 参数即可。</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/patch-binary-0a2e0fe071efb18bdf0d5d7aecb07e6b.png" width="862" height="651" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="步骤三安装-higress">步骤三：安装 Higress<a href="#步骤三安装-higress" class="hash-link" aria-label="步骤三：安装 Higress的直接链接" title="步骤三：安装 Higress的直接链接">​</a></h3><p>既然只是调试 pilot，那么其他组件还是要复用现有 Higress 集群里的。所以我们需要在本地配置一个 Higress 集群。大家可以参考这篇文档：<a href="/zh-cn/docs/user/quickstart">链接</a>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="开发与调试">开发与调试<a href="#开发与调试" class="hash-link" aria-label="开发与调试的直接链接" title="开发与调试的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="本地开发">本地开发<a href="#本地开发" class="hash-link" aria-label="本地开发的直接链接" title="本地开发的直接链接">​</a></h3><p>本地开发推荐使用 IDE JetBrains GoLand。我们直接在 GoLand 中打开 <code>external/istio</code> 目录，正常进行开发即可。</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/goland-project-9e47f05886a80bb1ac0a6113d4f4966f.png" width="1419" height="722" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="调试运行">调试运行<a href="#调试运行" class="hash-link" aria-label="调试运行的直接链接" title="调试运行的直接链接">​</a></h3><p><strong>环境准备</strong></p><p>第一步：提取配置文件</p><p>在本地任意一个位置创建一个目录，然后在该目录下执行以下命令，生成配置文件：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get configmap higress-config -n higress-system -o</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">jsonpath</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;{.data.mesh}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> ./mesh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get configmap higress-config -n higress-system -o</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">jsonpath</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;{.data.meshNetworks}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> ./meshNetworks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二步：转发 controller 端口</p><p>执行以下命令，将 controller 的 xDS 服务端口转发至本地：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl port-forward deployment/higress-controller -n higress-system </span><span class="token number" style="color:#36acaa">15051</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>代码调整</strong></p><p>如果要调试与 TLS 证书下发的相关功能，则需要在 <code>pilot/pkg/xds/ads.go</code> 的 <code>initConnection</code> 函数中添加代码，绕过证书下发过程的认证要求。代码修改方法请参考下方示例。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EnableXDSIdentityCheck </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> con</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Identities </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// TODO: allow locking down, rejecting unauthenticated requests.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">checkConnectionIdentity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">con</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Warnf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Unauthorized XDS: %v with identity %v: %v&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> con</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PeerAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> con</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Identities</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Newf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PermissionDenied</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;authorization failed: %v&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        con</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VerifiedIdentity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Start - Auth bypassing for local debug</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    con</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VerifiedIdentity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">spiffe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Identity</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TrustDomain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;cluster.local&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;higress-system&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServiceAccount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;higress-gateway&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// End - Auth bypassing for local debug</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>运行配置</strong></p><p>配置一：环境变量</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">CUSTOM_CA_CERT_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">higress-ca-root-cert</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">JWT_POLICY</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">none</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">PILOT_ENABLE_CROSS_CLUSTER_WORKLOAD_ENTRY</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">PILOT_ENABLE_GATEWAY_API</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">PILOT_ENABLE_GATEWAY_API_DEPLOYMENT_CONTROLLER</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">PILOT_ENABLE_GATEWAY_API_STATUS</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">PILOT_ENABLE_METADATA_EXCHANGE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">PILOT_SCOPE_GATEWAY_TO_NAMESPACE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">POD_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">higress-controller</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">POD_NAMESPACE</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">higress-system</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">REVISION</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">default</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">VALIDATION_ENABLED</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>配置二：命令行参数</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">discovery --monitoringAddr</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">:15014 --log_output_level</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">default:info --domain cluster.local --keepaliveMaxServerConnectionAge 30m --meshConfig </span><span class="token variable" style="color:#36acaa">${configDir}</span><span class="token plain">/mesh --networksConfig </span><span class="token variable" style="color:#36acaa">${configDir}</span><span class="token plain">/meshNetworks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意：其中的 <code>${configDir}</code> 为在<strong>环境准备</strong>一步创建的配置目录。</p><p><strong>启动调试</strong></p><p>在完成以上工作之后，我们就可以启动 Pilot 了。它的 main 函数定义在 <code>pilot/cmd/pilot-discovery/main.go</code> 文件中。</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/debug-run-b2c3f7a50afb761c6fb1e0182a190044.png" width="1501" height="435" class="img_ev3q"></p><p><strong>网关对接</strong></p><p>如果想要验证 pilot 下发配置到 gateway 的功能，我们需要修改 gateway 的配置，使之连接到处于开发状态的 pilot 实例。</p><p>第一步：修改 <code>higress-config</code> ConfigMap</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl edit configmap higress-config -n higress-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修改两个地方：</p><ol><li>将 <code>discoveryAddress</code> 修改为<code>本机IP:15010</code>；<br>注意：此处的本机 IP 不可以使用 127.0.0.1 等 loopback IP。需要使用本机有线或无线网卡的 IP。</li><li>在 <code>discoveryAddress</code> 下面添加一个新属性：<code>controlPlaneAuthPolicy: NONE</code>。</li></ol><p>修改后配置示例：</p><p><img loading="lazy" alt="img.png" src="data:image/png;base64,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" width="549" height="250" class="img_ev3q"></p><p>第二步：重启 Higress Gateway</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment higress-gateway -n higress-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重启后我们可以在 pilot 的控制台输出中看到 gateway 连接上来的并获取配置的日志。</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/gateway-connected-7884dc4a25d714a194c1605ba474d1a8.png" width="1494" height="462" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>本地调试和测试是开发过程中必不可少的环节。通过本文的介绍，希望大家可以更加方便的对 pilot 进行本地调试和e2e测试，提高开发效率。同时也希望能够有越来越多的开发者加入到 Higress 研发队伍中，为产品的升级迭代贡献一份力量。</p><p><a href="https://github.com/alibaba/higress/issues/480" target="_blank" rel="noopener noreferrer">欢迎参与阿里开源贡献👏</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="介绍如何在本地使用IDE等开发工具进行Higress控制台相关的开发和调试工作。"><meta itemprop="keywords" content="higress,console"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/console-dev">教程：如何在本地开发和调试 Higress 控制台</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-03-02T00:00:00.000Z" itemprop="datePublished">2024年3月2日</time> · <!-- -->阅读需 8 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">CH3CHO</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概述">概述<a href="#概述" class="hash-link" aria-label="概述的直接链接" title="概述的直接链接">​</a></h2><p>本文旨在介绍如何在本地使用 IDE 来进行 Higress 控制台（以下简称控制台）的开发和调试工作。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="代码结构">代码结构<a href="#代码结构" class="hash-link" aria-label="代码结构的直接链接" title="代码结构的直接链接">​</a></h2><p>控制台的代码仓库地址为 <a href="https://github.com/higress-group/higress-console" target="_blank" rel="noopener noreferrer">https://github.com/higress-group/higress-console</a>。</p><p>控制台项目使用了前后端分离的架构。在将代码下载到本地后，我们可以看到整个项目主要由以下三个目录组成：backend、frontend 和 helm。它们也分别对应了项目的三个部分：后端、前端和部署。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="backend后端部分">Backend：后端部分<a href="#backend后端部分" class="hash-link" aria-label="Backend：后端部分的直接链接" title="Backend：后端部分的直接链接">​</a></h3><p>后端部分是一个使用 Maven 构建配置的 Java 项目，其中共有两个模块：sdk 和 console。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="sdk">SDK<a href="#sdk" class="hash-link" aria-label="SDK的直接链接" title="SDK的直接链接">​</a></h4><p>sdk 中包含了定义了 Higress 治理平面的核心数据模型和业务逻辑，如路由模型、Wasm 插件模型、配置模型转换和读写逻辑等。它也同样作为一个独立产品发布到了 Maven 中央仓库。开发者可以世界使用这个 SDK 来进行面向 Higress 的治理功能开发（<a href="/zh-cn/blog/admin-sdk-intro">参考文档</a>）。</p><p>项目中的核心包如下：</p><ul><li>config：SDK 初始化配置模型</li><li>constant：各类常量</li><li>model：各类配置模型</li><li>service：核心业务逻辑服务<ul><li>kubernetes：与 K8s 模型和 API 相关的服务</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="console">Console<a href="#console" class="hash-link" aria-label="Console的直接链接" title="Console的直接链接">​</a></h4><p>console 中定义了控制台所使用的 Restful API 和一些界面相关的非核心功能，例如监控看板管理、用户配置管理等。</p><p>项目中的核心包如下：</p><ul><li>client：封装访问外部 API 的客户端 </li><li>constant：各类常量</li><li>controller：Restful API 控制器</li><li>service：业务服务逻辑</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="frontend前端部分">Frontend：前端部分<a href="#frontend前端部分" class="hash-link" aria-label="Frontend：前端部分的直接链接" title="Frontend：前端部分的直接链接">​</a></h3><p>前端部分是一个 NodeJS 项目，使用基于 React 的应用研发框架<a href="https://v3.ice.work/" target="_blank" rel="noopener noreferrer">飞冰（ICE）</a>搭建。</p><p>整个项目的目录结构如下：</p><ul><li>public：项目中使用到的静态资源</li><li>src：核心代码部分<ul><li>components：在项目中被复用的小型组件</li><li>interfaces：与 API 交互过程中需要使用到的数据模型</li><li>locales：国际化资源文件</li><li>models：前端页面上下文中需要使用到的数据模型</li><li>pages：各个前端页面及其内部组件</li><li>services：与 API 进行交互逻辑封装</li></ul></li><li>ice.config.mts：飞冰的项目配置文件</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="helm部署部分">Helm：部署部分<a href="#helm部署部分" class="hash-link" aria-label="Helm：部署部分的直接链接" title="Helm：部署部分的直接链接">​</a></h3><p>控制台使用 Helm Chart 进行部署。这一部分就是 Helm Chart 的代码。整体代码结构遵循 Helm 的官方规范，可参考 <a href="https://helm.sh/" target="_blank" rel="noopener noreferrer">Helm 官网</a>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="本地运行">本地运行<a href="#本地运行" class="hash-link" aria-label="本地运行的直接链接" title="本地运行的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="后端部分">后端部分<a href="#后端部分" class="hash-link" aria-label="后端部分的直接链接" title="后端部分的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="环境准备">环境准备<a href="#环境准备" class="hash-link" aria-label="环境准备的直接链接" title="环境准备的直接链接">​</a></h4><p>控制台的正常运行依赖 Higress 核心组件，所以需要先准备一个安装好的 Higress 集群。大家可以参考这篇文档：<a href="/zh-cn/docs/user/quickstart">链接</a>。考虑到本地调试的便利度，建议大家使用本地 K8s 环境的方法进行安装。</p><p>控制台的后端项目要求 Java 版本不低于 17，所以请确认本地安装的 JDK 版本满足要求。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="启动项目">启动项目<a href="#启动项目" class="hash-link" aria-label="启动项目的直接链接" title="启动项目的直接链接">​</a></h4><p>控制台的外部服务依赖主要有两个，一个是 K8s API，另一个是 Higress Controller。</p><p>访问 K8s API，控制台默认使用的是本地默认的 kubeconfig （即 <code>~/.kube/config</code>）。如果需要使用其他配置文件，则可以使用 <code>HIGRESS_CONSOLE_KUBE_CONFIG</code> 环境变量来指定对应的文件路径。</p><p>控制台在本地运行状态下，来访问 K8s 集群，使用本地的 15014 端口来访问 Higress Controller。可以使用以下命令将前面安装好的 Higress 实例中 controller 的 15014 端口映射到本地：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl port-forward deployment/higress-controller -n higress-system </span><span class="token number" style="color:#36acaa">15014</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="img.png" src="data:image/png;base64,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" width="646" height="76" class="img_ev3q"></p><p>然后使用项目的主类 <code>com.alibaba.higress.console.HigressConsoleApplication</code> 进行启动即可。等待启动完成后，我们就可以使用 <code>http://localhost:8080/</code> 来访问了。</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/backend-start-d3b6bc3a48ad899c0062afb5011466ea.png" width="1377" height="584" class="img_ev3q"></p><p>如果你是第一次启动，那么访问上述地址的时候会发现并没有页面出现。如果只是要调试 API，这样也是可以正常进行的。但如果要结合网页进行调试，那么需要使用以下命令执行一次 Maven 构建，生成前端页面资源：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./mvnw clean package -Dmaven.test.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="img.png" src="data:image/png;base64,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" width="739" height="282" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="前端部分">前端部分<a href="#前端部分" class="hash-link" aria-label="前端部分的直接链接" title="前端部分的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="依赖安装">依赖安装<a href="#依赖安装" class="hash-link" aria-label="依赖安装的直接链接" title="依赖安装的直接链接">​</a></h4><p>控制台的前端项目要求 NodeJS 的版本不低于 16，所以请确认本地安装的 NodeJS 版本满足要求。</p><p>然后使用以下命令安装项目所需的各个依赖包：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="项目启动">项目启动<a href="#项目启动" class="hash-link" aria-label="项目启动的直接链接" title="项目启动的直接链接">​</a></h4><p>使用以下命令契合启动前端页面项目：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">npm</span><span class="token plain"> start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="img.png" src="data:image/png;base64,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" width="876" height="263" class="img_ev3q"></p><p>默认情况下，前端页面会访问 Higress 官方提供的演示版控制台 API。如果不希望影响线上演示数据，或需要与后端 API 进行联调的话，可以修改项目根目录下的 <code>ice.config.mts</code> 文件，将其中的 <code>http://demo.higress.io/</code> 替换为本地的服务地址（例如：<code>http://127.0.0.1:8080/</code>），然后重新启动前端项目。这样页面上访问的就是本地的测试服务了。</p><p><img loading="lazy" alt="img.png" src="data:image/png;base64,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" width="433" height="145" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="镜像构建">镜像构建<a href="#镜像构建" class="hash-link" aria-label="镜像构建的直接链接" title="镜像构建的直接链接">​</a></h2><p>在命令行下进入 <code>backend</code> 目录并执行 <code>build.sh</code> 即可启动镜像构建。构建生成的镜像名称为 <code>higress-console:0.0.1</code>。</p><p>注意：如果尝试在 Windows 下构建，请务必确认该目录下的 <code>start.sh</code> 使用的是 Linux 的换行符（即 <code>LF</code>）。否则，构建生成的镜像将无法正常运行。</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/image-build-f640299dc16ddf34dc5cdc5fd7aa2bde.png" width="994" height="399" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>控制台为用户提供了 Higress 治理侧的重要组成部分，为用户提供了基础的开箱即用体验。社区也会在控制台方面持续发力，为用户提供更丰富的、更便捷的网关治理体验。希望本文可以让更多的开发者加入控制台的研发队伍中，为控制台的升级迭代贡献一份力量。</p><p><a href="https://github.com/alibaba/higress/issues/480" target="_blank" rel="noopener noreferrer">欢迎参与阿里开源贡献👏</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="介绍如何使用 Higress Admin SDK 来管理 Higress 的服务来源、服务路由等各项配置。"><meta itemprop="keywords" content="Higress,SDK,Config"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/admin-sdk-intro">如何使用 Higress Admin SDK 进行配置管理</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-02-08T00:00:00.000Z" itemprop="datePublished">2024年2月8日</time> · <!-- -->阅读需 5 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">CH3CHO</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Higress 一个遵循开源 Ingress/Gateway API 标准，提供流量调度、服务治理、安全防护三合一的高集成、易使用、易扩展、热更新的下一代云原生网关。而配置管理网关的运维工作中扮演者重要的角色。如何让配置管理自动化，尤其是与其他的运维系统进行对接，就成为了一个非常迫切的需求。本文将介绍如何使用 Higress Admin SDK 来管理 Higress 系统内的各类配置。希望能够对存在此类需求的朋友有所帮助。</p><h1>2. Higress Admin SDK</h1><p>Higress Admin SDK 脱胎于 Higress Console。起初，它是作为 Higress Console 的一部分，为前端界面提供实际的功能支持。后来考虑到对接外部系统等需求，我们将配置管理的部分剥离出来，形成一个独立的逻辑组件，便于各个系统进行对接。目前支持服务来源管理、服务管理、路由管理、域名管理、证书管理、插件管理等功能。</p><p>Higress Admin SDK 现在只提供 Java 版本，且要求 JDK 版本不低于 17。</p><h1>3. 开发实操</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-环境准备">3.1 环境准备<a href="#31-环境准备" class="hash-link" aria-label="3.1 环境准备的直接链接" title="3.1 环境准备的直接链接">​</a></h2><p>这里我们以本地基于 Kind 搭建的 K8s 集群作为实验环境。所以首先，请大家参考这篇<a href="https://higress.io/zh-cn/docs/user/quickstart#%E5%9C%BA%E6%99%AF%E4%BA%8C%E5%9C%A8%E6%9C%AC%E5%9C%B0-k8s%E7%8E%AF%E5%A2%83%E4%B8%AD%E4%BD%BF%E7%94%A8" target="_blank" rel="noopener noreferrer">文档</a>在本地完成 K8s 集群的搭建和 Higress 的安装。</p><p>然后，我们需要创建一个测试用的 K8s 服务。大家可以将下方的 YAML 保存为 <code>test.yaml</code>，然后执行 <code>kubectl apply -f test.yaml</code> 命令在 K8s 中创建对应的资源。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mendhak/http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">https</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">echo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">29</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-代码编写">3.2 代码编写<a href="#32-代码编写" class="hash-link" aria-label="3.2 代码编写的直接链接" title="3.2 代码编写的直接链接">​</a></h2><p>这里的目标是创建一个路由，使 <code>http://www.test.com/</code> 这个 URL 指向我们刚刚创建的 <code>higress-demo-service</code>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第一步配置依赖">第一步：配置依赖<a href="#第一步配置依赖" class="hash-link" aria-label="第一步：配置依赖的直接链接" title="第一步：配置依赖的直接链接">​</a></h3><p>根据项目所使用的构建工具来添加 Higress Admin SDK 依赖：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">io.higress.api</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">higress-admin-sdk</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">0.0.2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-gradle codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gradle codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">implementation</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;io.higress.api:higress-admin-sdk:0.0.2&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第二步创建-higress-sdk-实例">第二步：创建 Higress SDK 实例<a href="#第二步创建-higress-sdk-实例" class="hash-link" aria-label="第二步：创建 Higress SDK 实例的直接链接" title="第二步：创建 Higress SDK 实例的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">String</span><span class="token plain"> kubeConfigFile </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Paths</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.home&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/.kube/config&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">HigressServiceConfig</span><span class="token plain"> config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HigressServiceConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">withKubeConfigPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kubeConfigFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">HigressServiceProvider</span><span class="token plain"> provider </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HigressServiceProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里我们使用的是 K8s 集群外的配置方式，所以需要设置 kubeConfig 文件的路径，以便 SDK 操作 K8s 内的各类资源。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第二步创建域名">第二步：创建域名<a href="#第二步创建域名" class="hash-link" aria-label="第二步：创建域名的直接链接" title="第二步：创建域名的直接链接">​</a></h3><p>这里我们使用 SDK 中的 <code>DomainService</code> 来创建一个 <code>www.test.com</code> 域名，并将该域名设置为只开放 HTTP 访问。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Domain</span><span class="token plain"> domain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Domain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;www.test.com&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enableHttps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Domain</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">EnableHttps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">OFF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">domainService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">domain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="第三步创建路由">第三步：创建路由<a href="#第三步创建路由" class="hash-link" aria-label="第三步：创建路由的直接链接" title="第三步：创建路由的直接链接">​</a></h3><p>这里我们使用 SDK 中的 <code>DomainService</code> 来创建一个名为 <code>higress-demo</code> 的路由。路由绑定 <code>www.test.com</code> 域名，匹配所有以 <code>/</code> 开头的请求，并将请求转发至 <code>higress-demo-service.default.svc.cluster.local</code> 服务的 8080 端口。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Route</span><span class="token plain"> route </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Route</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;higress-demo&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">domains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">singletonList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;www.test.com&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RoutePredicate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">matchType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RoutePredicateTypeEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PRE</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">matchValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">services</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">singletonList</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">UpstreamService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;higress-demo-service.default.svc.cluster.local:8080&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">routeService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">route</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="33-测试验证">3.3 测试验证<a href="#33-测试验证" class="hash-link" aria-label="3.3 测试验证的直接链接" title="3.3 测试验证的直接链接">​</a></h2><p>执行编写好的代码：确认一切正常。然后在 Shell 中执行以下命令，检查请求路由情况。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -svk http://localhost/ -H </span><span class="token string" style="color:#e3116c">&quot;Host: www.test.com&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>能够以 JSON 格式返回请求的详细信息就说明路由配置已经可以正常工作。</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;path&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;headers&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;host&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;www.test.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;user-agent&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;curl/8.4.0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;accept&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*/*&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-forwarded-for&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.42.0.230&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-forwarded-proto&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-envoy-internal&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-request-id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;4a3db96b-c46c-4c8a-a60f-a513f258736d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-envoy-decorator-operation&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;higress-demo-service.default.svc.cluster.local:8080/*&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-envoy-attempt-count&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-b3-traceid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a426d189c027371957f008c2cb2e9e8f&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-b3-spanid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;57f008c2cb2e9e8f&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x-b3-sampled&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;req-start-time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1707363093608&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;original-host&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;www.test.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;method&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;GET&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;body&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;fresh&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;www.test.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;ip&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.42.0.230&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;ips&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;10.42.0.230&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;protocol&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;query&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;subdomains&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;www&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;xhr&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;os&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;higress-demo-app&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;connection&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-总结">4. 总结<a href="#4-总结" class="hash-link" aria-label="4. 总结的直接链接" title="4. 总结的直接链接">​</a></h2><p>目前 Higress Admin SDK 支持的功能还比较简单。未来社区也会在进一步着力增强 Higress 的治理侧功能，SDK 的能力也会不断完善。大家对 SDK 和 Console 有任何疑问和建议，都欢迎在 <a href="https://github.com/higress-group/higress-console" target="_blank" rel="noopener noreferrer">GitHub</a> 上提出。感谢大家的支持！</p><p>以上实操过程的项目代码可以在这里下载：<a target="_blank" href="/zh-cn/assets/files/20240208_higress-admin-sdk-demo-f1a76d3b8534c6c881dd6404e406ee4e.zip">下载链接</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="通过分析higress-core源码，了解higress-core自启动以来做了哪些事情"><meta itemprop="keywords" content="higress"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/higress-code">higress-core源码分析</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-01-25T00:00:00.000Z" itemprop="datePublished">2024年1月25日</time> · <!-- -->阅读需 27 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">SJC</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="引言">引言<a href="#引言" class="hash-link" aria-label="引言的直接链接" title="引言的直接链接">​</a></h2><p>在开源社区中，源码分析是深入理解项目内部机制的关键步骤。通过仔细研究项目的源代码，我们可以揭示背后的设计原理、算法和工作流程。这不仅有助于提高我们的编程技能，还可以为开发者社区提供宝贵的学习资源。</p><p>本文将聚焦于分析<a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">Higress</a>的源码，该项目在开源界备受瞩目。通过浏览阅读其代码，我们将初步展现其核心特性、架构设计和实现细节。希望各位用户以及开发者在本文中能够找到有价值的见解。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于higress">关于Higress<a href="#关于higress" class="hash-link" aria-label="关于Higress的直接链接" title="关于Higress的直接链接">​</a></h2><p>Higress是基于阿里内部的Envoy Gateway实践沉淀、以开源Istio + Envoy为核心构建的下一代云原生网关，实现了流量网关 + 微服务网关 + 安全网关三合一的高集成能力，深度集成Dubbo、Nacos、Sentinel等微服务技术栈，能够帮助用户极大的降低网关的部署及运维成本且能力不打折；在标准上全面支持Ingress与Gateway API，积极拥抱云原生下的标准API规范；同时，Higress Controller也支持Nginx Ingress平滑迁移，帮助用户零成本快速迁移到Higress。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="代码目录说明">代码目录说明<a href="#代码目录说明" class="hash-link" aria-label="代码目录说明的直接链接" title="代码目录说明的直接链接">​</a></h2><ul><li>cmd: 命令行参数解析等处理代码</li><li>pkg/ingress: Ingress 资源转换为 Istio 资源等相关代码</li><li>pkg/bootstrap: 包括启动 gRPC/xDS/HTTP server 等的代码</li><li>registry: 实现对接多种注册中心进行服务发现的代码</li><li>envoy: 依赖的 envoy 官方仓库 commit，以及对应的补丁代码</li><li>istio: 依赖的 istio 官方仓库 commit，以及对应的补丁代码</li><li>plugins: Higress 插件 sdk，以及官方内置插件代码</li><li>script: 编译相关脚本</li><li>docker: docker 镜像构建相关脚本</li></ul><p>本文主要围绕着higress-core组件的源码，研究higress-core自启动以来做了哪些事情。higress-core的代码主要位于<code>pkg</code>目录下。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-core源码整体分析">higress-core源码整体分析<a href="#higress-core源码整体分析" class="hash-link" aria-label="higress-core源码整体分析的直接链接" title="higress-core源码整体分析的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动入口pkgcmdservergo">启动入口：pkg/cmd/server.go<a href="#启动入口pkgcmdservergo" class="hash-link" aria-label="启动入口：pkg/cmd/server.go的直接链接" title="启动入口：pkg/cmd/server.go的直接链接">​</a></h3><p>在该文件下，主要进行了命令参数的解析，并调用<code>NewServer</code>来创建一个Server实例，调用该实例的<code>Start</code>方法来启动实例Server，调用<code>waitForMonitorSignal</code>方法来监听进程的退出。</p><p>显然这里有两个很重要的方法函数：<code>NewServer</code>和<code>Start</code>，接下来针对这两个函数进行具体分析。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建实例newserver">创建实例：NewServer<a href="#创建实例newserver" class="hash-link" aria-label="创建实例：NewServer的直接链接" title="创建实例：NewServer的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="初始化pilot的环境-apimodelenvironment">初始化Pilot的环境 API<code>model.Environment</code><a href="#初始化pilot的环境-apimodelenvironment" class="hash-link" aria-label="初始化pilot的环境-apimodelenvironment的直接链接" title="初始化pilot的环境-apimodelenvironment的直接链接">​</a></h4><p><code>model.Environment</code>为Pilot 中的核心环境对象，集成了许多不同的组件，包括服务发现、配置存储、网络观察等，以提供一个完整的环境 API。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Environment</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PushContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewPushContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DomainSuffix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> constants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultKubernetesDomain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MCPMode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="为modelenvironment设置ledger">为<code>model.Environment</code>设置<code>Ledger</code><a href="#为modelenvironment设置ledger" class="hash-link" aria-label="为modelenvironment设置ledger的直接链接" title="为modelenvironment设置ledger的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetLedger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">buildLedger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RegistryOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Ledger</code> 是一个表示经过修改的 map 的接口。这个 map 具有三个独特的特征：</p><ol><li>每个 map 的唯一状态都有一个唯一的哈希值。</li><li>map 的先前状态在固定的时间内被保留。</li><li>给定先前的哈希值，我们可以从 map 中检索先前的状态（如果仍然被保留）。</li></ol><p><code>Ledger</code>提供了个接口来获取之前版本的Value，接口详情如下：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// GetPreviousValue executes a get against a previous version of the ledger, using that version&#x27;s root hash.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetPreviousValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">previousRootHash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="为modelenvironment设置服务发现的接口servicediscovery用于列举服务和实例">为<code>model.Environment</code>设置服务发现的接口<code>ServiceDiscovery</code>，用于列举服务和实例。<a href="#为modelenvironment设置服务发现的接口servicediscovery用于列举服务和实例" class="hash-link" aria-label="为modelenvironment设置服务发现的接口servicediscovery用于列举服务和实例的直接链接" title="为modelenvironment设置服务发现的接口servicediscovery用于列举服务和实例的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ac </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> aggregate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">aggregate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MeshHolder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceDiscovery </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ac</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="初始化server实例">初始化<code>Server</code>实例<a href="#初始化server实例" class="hash-link" aria-label="初始化server实例的直接链接" title="初始化server实例的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerArgs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    httpMux</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">         http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewServeMux</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readinessProbes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">readinessProbe</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">          server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Watcher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mesh</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewFixedWatcher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1alpha1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MeshConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里说明一下<code>Server</code>结构体的各个字段的含义：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Server </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ServerArgs  </span><span class="token comment" style="color:#999988;font-style:italic">// Server参数配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment      </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Environment  </span><span class="token comment" style="color:#999988;font-style:italic">// Pilot环境配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubeClient       higresskube</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client  </span><span class="token comment" style="color:#999988;font-style:italic">// 与 Kubernetes 集成的客户端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configController model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ConfigStoreCache  </span><span class="token comment" style="color:#999988;font-style:italic">// 配置存储控制器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configStores     </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ConfigStoreCache  </span><span class="token comment" style="color:#999988;font-style:italic">// 多个配置存储的缓存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    httpServer       </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Server  </span><span class="token comment" style="color:#999988;font-style:italic">// HTTP 请求处理器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    httpMux          </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServeMux  </span><span class="token comment" style="color:#999988;font-style:italic">// HTTP 请求多路复用器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    grpcServer       </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Server  </span><span class="token comment" style="color:#999988;font-style:italic">// grpc服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xdsServer        </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">xds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DiscoveryServer  </span><span class="token comment" style="color:#999988;font-style:italic">// xds服务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server           server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Instance  </span><span class="token comment" style="color:#999988;font-style:italic">// Pilot Server实例配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readinessProbes  </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">readinessProbe  </span><span class="token comment" style="color:#999988;font-style:italic">// server内部服务记录表，记录服务是否准备好</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>在这里，<code>server.Instance</code>维护了一个chan变量<code>components chan Component</code>，<code>Component</code>则定义了一个函数方法模板。当我们调用<code>Instance</code>的<code>RunComponent(t Component)</code>方法，则会将变量<code>t</code>发送给<code>components</code>管道，而我们调用<code>Instance</code>的<code>Start(stop &lt;-chan struct{}) error</code>方法，则会从<code>components</code>管道去接收<code>Component</code>对象，并执行该对象的函数方法。</p></blockquote><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Component func(stop &lt;-chan struct{}) error</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建初始启动函数列表">创建初始启动函数列表<a href="#创建初始启动函数列表" class="hash-link" aria-label="创建初始启动函数列表的直接链接" title="创建初始启动函数列表的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">initFuncList </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initKubeClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initXdsServer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initHttpServer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initConfigController</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initRegistryEventHandlers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initAuthenticators</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p><code>initKubeClient</code>函数</p><ol><li><p>首先判断<code>kubeClient</code>是否为空，不为空进行下一步；</p></li><li><p>调用<code>istiokube.DefaultRestConfig</code>方法，创建一个具有 RESTful 风格的<code>Kubernetes Config</code>；</p></li><li><p>以<code>Kubernetes Config</code>为入参，调用<code>istiokube.NewClientConfigForRestConfig</code>方法创建一个具有 RESTful 风格的<code>Kubernetes Client Config</code>；</p></li><li><p>调用higress定义的<code>NewClient</code>方法，集成 Istio 客户端、Higress 客户端和可能的 Kingress 客户端，并为每个客户端设置了相应的 SharedInformerFactory。</p></li></ol></li><li><p><code>initXdsServer</code>函数</p><ol><li>调用<code>pliot xds</code>的<code>NewDiscoveryServer</code>方法，创建一个<code>xdsServer</code>实例，并初始化一些资源。<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> xds</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewDiscoveryServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PodName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PodNamespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RegistryOptions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">KubeOptions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClusterAliases</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPlugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmpluginGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DestinationRule</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DestinationRuleGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EnvoyFilter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EnvoyFilterGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Gateway</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GatewayGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualServiceGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpGenerators</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceEntry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mcp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceEntryGenerator</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ProxyNeedsPush </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">proxy </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Proxy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PushRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>将<code>xdsServer</code>的<code>Start</code>方法注册给pilot server instance，并调用higress server的<code>initGrpcServer</code>初始化函数，将xds服务注册在grpc服务上，使得可以通过grpc协议端口进行xds协议的通信。</li></ol></li><li><p><code>initHttpServer</code>函数，初始化http server，添加8888端口的debug接口的处理器，并添加<code>/ready</code>路由的处理器，用于遍历higress server的<code>readinessProbes</code>，判断内部服务记录表内的服务是否准备完毕。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xdsServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddDebugHandlers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">httpMux</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">httpMux</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HandleFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/ready&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">readyHandler</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><code>initConfigController</code>函数，这部分内容比较核心，将会在后面详细展开，暂时先跳过。</p></li><li><p><code>initRegistryEventHandlers</code>函数，这部分内容跟<code>initConfigController</code>函数有关，暂时先跳过。</p></li><li><p><code>initAuthenticators</code>函数，顾名思义，就是初始化认证器，并将其应用于 xDS 服务器。通过添加不同的认证器，可以支持不同的身份验证方式，这样服务器在处理请求时可以验证客户端的身份信息。</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="遍历启动函数列表执行启动函数">遍历启动函数列表，执行启动函数<a href="#遍历启动函数列表执行启动函数" class="hash-link" aria-label="遍历启动函数列表，执行启动函数的直接链接" title="遍历启动函数列表，执行启动函数的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> initFuncList </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="注册pilot-server">注册Pilot Server<a href="#注册pilot-server" class="hash-link" aria-label="注册Pilot Server的直接链接" title="注册Pilot Server的直接链接">​</a></h4><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RunComponent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kubeClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RunAndWait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>注意这里的<code>kubeClient</code>所调用的方法是<code>istio</code>的Kubernetes客户端提供的。</p></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="在ready服务记录表里注册xds服务">在ready服务记录表里注册xds服务<a href="#在ready服务记录表里注册xds服务" class="hash-link" aria-label="在ready服务记录表里注册xds服务的直接链接" title="在ready服务记录表里注册xds服务的直接链接">​</a></h4><div class="language-gog codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gog codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">s.readinessProbes[&quot;xds&quot;] = func() (bool, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return s.xdsServer.IsServerReady(), nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动实例start">启动实例：Start<a href="#启动实例start" class="hash-link" aria-label="启动实例：Start的直接链接" title="启动实例：Start的直接链接">​</a></h3><ul><li>第一部分：遍历pilot server的<code>components</code>，执行chan管道里的函数</li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>第二部分：等待缓存同步完成</li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">waitForCacheSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;failed to sync cache&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>第三部分：启动grpc服务</li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">grpcListener</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tcp&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GrpcAddress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;starting gRPC discovery service at %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> grpcListener</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Addr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">grpcServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">grpcListener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;error serving GRPC server: %v&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>第四部分：启动http服务</li></ul><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">httpListener</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tcp&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HttpAddress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;starting HTTP service at %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> httpListener</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Addr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">httpServer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">httpListener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;error serving http server: %v&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-core核心源码分析">higress-core核心源码分析<a href="#higress-core核心源码分析" class="hash-link" aria-label="higress-core核心源码分析的直接链接" title="higress-core核心源码分析的直接链接">​</a></h2><p>在前面有两个函数<code>initConfigController</code>和<code>initRegistryEventHandlers</code>我们没有介绍，这两个函数可以说是higress-core的核心代码，接下来对这两个函数进行具体剖析。在分析之前，我们先看一下<code>pkg</code>其他目录的功能。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── common //公共包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── config //配置包</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── ingress //higress定义的ingress资源控制器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── config //配置ingress config和kingress config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── kube //集成Kubernetes配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── annotations //处理 Ingress 的注解相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── common //通用的代码和工具函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── configmap //处理 ConfigMap 相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── controller //控制器相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── http2rpc //处理 HTTP 到 RPC 的转换的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── ingress //处理 Ingress 配置的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── ingressv1 //Ingress 的 API 版本 v1 相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── kingress //处理 Kingress 相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── mcpbridge //MCP（Mesh Configuration Protocol）的桥接相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── secret //处理 Secret 相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── util //通用的工具函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── wasmplugin //处理 WebAssembly 插件相关的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── log //日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── mcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── translation //翻译模块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── kube //higress定义的Kubernetes客户端，包含了istio提供的Kubernetes客户端</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过目录我们可以清晰地看到higress集成了多个Kubernetes资源以及Ingress配置。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="initconfigcontroller函数剖析"><code>initConfigController</code>函数剖析<a href="#initconfigcontroller函数剖析" class="hash-link" aria-label="initconfigcontroller函数剖析的直接链接" title="initconfigcontroller函数剖析的直接链接">​</a></h3><p>我们先大致分析一下这个函数的流程，函数的具体逻辑稍后分析。最后会给出一个函数调用的流程图，可以结合流程图进行源码的理解分析。</p><ol><li>设置 <code>common.Options</code> 结构体的一些选项，这些选项可能影响配置控制器的行为。这些选项包括是否启用控制器、集群 ID、Ingress 类等</li><li>创建一个 <code>translation.NewIngressTranslation</code> 对象，该对象用于处理 Ingress 的翻译和配置</li><li>向 <code>ingressConfig</code> 中添加本地集群的配置，并获取对应的 Ingress 控制器和 Kingress 控制器</li><li>使用 <code>configaggregate.MakeCache</code> 创建一个带有缓存的配置控制器</li><li>创建一个 Istio 配置存储，并将其设置到 <code>Server</code> 对象的 <code>environment.IstioConfigStore</code> 中</li><li>将 <code>ingressConfig</code> 设置到 <code>Server</code> 对象的 <code>environment.IngressStore</code> 中</li><li>将包含配置和启动 Ingress 控制器、Kingress 控制器以及相关的配置控制器的函数方法注册到pilot server instance的<code>components</code>管道中。</li></ol><p>我们从中挑选出几个比较重要的函数出来：<code>NewIngressTranslation</code>、<code>AddLocalCluster</code>、<code>InitializeCluster</code>以及<code>configController</code>的<code>Run</code>方法，其它的像<code>MakeCache</code>、<code>MakeIstioStore</code>方法则是有<code>istio</code>提供的函数方法，用于对接higress中的discovery容器中<code>Pilot</code>组件。确定好接下来要分析的内容之后，我们来到<code>pkg/ingress/translattion</code>目录，查看一下<code>translation.go</code>。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="translationgo剖析"><code>translation.go</code>剖析<a href="#translationgo剖析" class="hash-link" aria-label="translationgo剖析的直接链接" title="translationgo剖析的直接链接">​</a></h4><p><code>IngressTranslation</code>实现了两个接口：<code>model.ConfigStoreCache</code>和<code>model.IngressStore</code>，其中<code>model.ConfigStoreCache</code>还包含了<code>model.ConfigStore</code>接口。我们可以大致浏览一下，可以发现基本上是调用<code>IngressTranslation</code>结构体中的<code>ingressConfig</code>和<code>kingressConfig</code>的方法，位于<code>pkg/ingress/config</code>目录下。</p><p>除了实现接口方法之外，还提供了<code>NewIngressTranslation</code>、<code>AddLocalCluster</code>、<code>InitializeCluster</code>方法。同样地，我们也可以发现这三个方法本质上也是调用<code>ingressConfig</code>和<code>kingressConfig</code>的方法。</p><p>既然<code>translation.go</code>本质上是调用<code>pkg/ingress/config</code>目录下的函数，不妨我们进入该目录，查看一下<code>ingress_config.go</code>，对于<code>kingress_config.go</code>，我们暂不做分析。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="ingress_configgo剖析"><code>ingress_config.go</code>剖析<a href="#ingress_configgo剖析" class="hash-link" aria-label="ingress_configgo剖析的直接链接" title="ingress_configgo剖析的直接链接">​</a></h4><p>在<code>ingress_config.go</code>中有一个名为<code>IngressConfig</code>结构体，内容如下(附带注释)：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> IngressConfig </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 远程 Ingress 控制器的映射，键为集群 ID，值为 common.IngressController</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remoteIngressControllers </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IngressController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 用于保护并发访问 remoteIngressControllers 的互斥锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mutex sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RWMutex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Ingress 路由和域名的缓存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingressRouteCache  model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IngressRouteCollection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingressDomainCache model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IngressDomainCollection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 本地 Kubernetes 客户端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    localKubeClient kube</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 VirtualService 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtualServiceHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 Gateway 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gatewayHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 DestinationRule 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destinationRuleHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 EnvoyFilter 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    envoyFilterHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 ServiceEntry 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serviceEntryHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理 WasmPlugin 事件的事件处理程序切片</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wasmPluginHandlers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 用于处理监视错误的处理程序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    watchErrorHandler cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WatchErrorHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 缓存的 EnvoyFilter 配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cachedEnvoyFilters </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 正在监视的 Secret 集合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    watchedSecretSet sets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 用于协调注册表的调解器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RegistryReconciler </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">reconcile</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Reconciler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// MCP 桥接是否已调解的标志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mcpbridgeReconciled </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 管理 MCP 桥接相关的控制器和列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mcpbridgeController mcpbridge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpBridgeController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mcpbridgeLister     netlisterv1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">McpBridgeLister</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 管理 WasmPlugin 相关的控制器和列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wasmPluginController wasmplugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPluginController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wasmPluginLister     extlisterv1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPluginLister</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 已注册的 WasmPlugin 集合，键为 WasmPlugin 名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wasmPlugins </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">extensions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPlugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 管理 HTTP2RPC 相关的控制器和列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http2rpcController http2rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Http2RpcController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http2rpcLister     netlisterv1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Http2RpcLister</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 已注册的 HTTP2RPC 集合，键为 HTTP2RPC 名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http2rpcs </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">higressv1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Http2Rpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Configmap 的管理器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configmapMgr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">configmap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ConfigmapMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 用于更新 XDS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    XDSUpdater model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">XDSUpdater</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 处理注解的注解处理程序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotationHandler annotations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AnnotationHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 命名空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    namespace </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 集群 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clusterId </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>该结构体提供了一些方法，其实这个结构体本质上也是实现了<code>translation.go</code>提到的两个接口，方法列表和<code>translation.go</code>极其相似，我们分析一下一些比较复杂的方法，剩下的可自行定位到源码查看：</p><ul><li><p><code>NewIngressConfig</code></p><ol><li>初始化<code>IngressConfig</code>，创建多个子控制器(mcpbridge、wasmplugin、http2rpc等)并赋值给对应的字段上。</li><li>为多个子控制器注册事件监听器，用于监听Kubernetes资源的变化，并进行相应的处理。<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">IngressConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remoteIngressControllers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IngressController</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    localKubeClient</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">          localKubeClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    XDSUpdater</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">               XDSUpdater</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    annotationHandler</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        annotations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewAnnotationHandlerManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mcpbridgeController </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> mcpbridge</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localKubeClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clusterId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mcpbridgeController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddEventHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AddOrUpdateMcpBridge</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeleteMcpBridge</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mcpbridgeController </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mcpbridgeController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mcpbridgeLister </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mcpbridgeController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Lister</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li></ul><p>在这里，有几个方法需要注意：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. `annotations.NewAnnotationHandlerManager()`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. `mcpbridge.NewController(localKubeClient, clusterId)`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. `wasmplugin.NewController(localKubeClient, clusterId)`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. `http2rpc.NewController(localKubeClient, clusterId)`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. `configmap.NewController(localKubeClient, clusterId, namespace)`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>很明显这些方法分别对应<code>pkg/ingress/kube</code>目录下一些自定义的资源配置方法，后面会针对该目录进行单独的介绍。</p><ul><li><p><code>RegisterEventHandler</code></p><ol><li><p>对kind变量进行判断，判断属于哪种资源，并添加到对应的事件处理程序切片</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> kind </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualService</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">virtualServiceHandlers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">virtualServiceHandlers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>注册事件监听器</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> remoteIngressController </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">remoteIngressControllers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remoteIngressController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterEventHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们可以定位一下<code>remoteIngressController</code>的<code>RegisterEventHandler</code>方法：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RegisterEventHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kind config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GroupVersionKind</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> kind </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualService</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">virtualServiceHandlers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">virtualServiceHandlers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li><li><p><code>AddLocalCluster</code></p><ol><li>创建ingress总控制器，并注册到<code>remoteIngressControllers</code>中<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ingressController </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingress</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewController</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">localKubeClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">localKubeClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> secretController</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">remoteIngressControllers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClusterId</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingressController</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li><li><p><code>InitializeCluster</code></p><ol><li>设置错误监听处理器<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingressController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetWatchErrorHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">watchErrorHandler</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>其中<code>SetWatchErrorHandler</code>方法如下，调用各个informer的<code>SetWatchErrorHandler</code>方法：<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">controller</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetWatchErrorHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handler </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Reflector</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> errs </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serviceInformer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetWatchErrorHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       errs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> multierror</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">errs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ingressInformer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetWatchErrorHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       errs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> multierror</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">errs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>通过go协程启动<code>ingressController</code><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> ingressController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li><li><p><code>List</code></p><ol><li><p>前期检查，预防空指针或逻辑错误</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Gateway </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualService </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DestinationRule </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EnvoyFilter </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServiceEntry </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typ </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPlugin </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrUnsupportedOp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Currently, only support list all namespaces gateways or virtualservices.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> namespace </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IngressLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Warnf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ingress store only support type %s of all namespace.&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> typ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrUnsupportedOp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>如果kind类型是envoyfilter，拿出来处理掉</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> typ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EnvoyFilter </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Build configmap envoy filters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configmapEnvoyFilters</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">configmapMgr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ConstructEnvoyFilters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>如果不是，调用ingress控制器(如果有kingress控制器，也给带上)的<code>List</code>方法，添加到config列表，以ingress控制器的方法为例，会获取informer对象的存储器，并对其进行遍历，将遍历到的对象进行深拷贝，并返回config列表。由于<code>List</code>方法是实现<code>ConfigStore</code>接口的，<code>istio</code>内部会对这个config列表进行下一步处理。</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> configs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mutex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ingressController </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">remoteIngressControllers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ingressController</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mutex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RUnlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>对config列表根据创建时间进行排序，并创建一个包装好的config列表，wrapperConfigs里除了<code>Config``，还会包含</code>AnnotationsConfig`注解配置</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SortIngressByCreationTime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wrapperConfigs </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">createWrapperConfigs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configs</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>根据kind类型，将wrapperConfigs转换为对应的资源，代码如下，并为convertGateways附加注释</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> typ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Gateway</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//1.初始化ConvertOptions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//2.调用ingress控制器的ConvertGateway方法，在这里，ingress控制器首先做一些检查，并遍历rule规则列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//  为每个rule创建IngressDomainBuilder构造器，中间过程会构造gateway包装器、获取tls密钥名称等等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//  在这个过程中会对config包装器进行修改</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//3.apply注解</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//4.组合成istio能够识别的config列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">convertGateways</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wrapperConfigs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VirtualService</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">convertVirtualService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wrapperConfigs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> gvk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DestinationRule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">convertDestinationRule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wrapperConfigs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这块内容较多，具备一定的难度，需要对各个资源有一定的理解。</p></li></ol></li></ul><p>以下几个方法的作用是极为相似的</p><ul><li><code>AddOrUpdateWasmPlugin</code></li><li><code>DeleteWasmPlugin</code></li><li><code>AddOrUpdateMcpBridge</code></li><li><code>DeleteMcpBridge</code></li><li><code>AddOrUpdateHttp2Rpc</code></li><li><code>DeleteHttp2Rpc</code></li></ul><p>顾名思义，就是在监听对应资源的过程中，发生资源的添加或者变更或者删除进行对应的操作。</p><p>以<code>AddOrUpdateWasmPlugin</code>和<code>DeleteWasmPlugin</code>为例。</p><ul><li><p><code>AddOrUpdateWasmPlugin</code></p><ol><li>获取wasmplugin<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wasmPlugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wasmPluginLister</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WasmPlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clusterNamespacedName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clusterNamespacedName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>将wasmplugin转化为istio能够识别的wasmplugin<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">istioWasmPlugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">convertIstioWasmPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wasmPlugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>更新<code>IngressConfig</code><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wasmPlugins</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">clusterNamespacedName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> istioWasmPlugin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li><li><p><code>DeleteWasmPlugin</code></p><ol><li>更新<code>IngressConfig</code><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wasmPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clusterNamespacedName</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>如果存在该wasmplugin，触发<code>wasmPluginHandlers</code>的事件监听器，执行对应的操作<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wasmPluginHandlers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IngressLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debug</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;WasmPlugin triggerd update&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Meta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Meta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventDelete</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol></li></ul><p>到此为此，<code>ingress_config.go</code>的内容基本介绍完毕，大部分内容并未做过多深入，感兴趣的朋友可以自行下载源码浏览查看。</p><p>我们现在回到最开始的<code>initConfigController</code>函数上，可以发现这个函数的核心内容其实就是<code>ingress_config.go</code>，当然还有对应的多个控制器，关于控制器的介绍，将在后面进行介绍。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="initregistryeventhandlers函数剖析"><code>initRegistryEventHandlers</code>函数剖析<a href="#initregistryeventhandlers函数剖析" class="hash-link" aria-label="initregistryeventhandlers函数剖析的直接链接" title="initregistryeventhandlers函数剖析的直接链接">​</a></h3><p>该函数相对于<code>initConfigController</code>函数来说简单很多，其主要做的内容就是配置xds更新处理器，并将其作为事件监听器的事件处理程序，注册给<code>configController</code>，也就是说，当发生资源的变更时，会通过xds协议进行推送更新。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pkgingresskube目录介绍"><code>pkg/ingress/kube</code>目录介绍<a href="#pkgingresskube目录介绍" class="hash-link" aria-label="pkgingresskube目录介绍的直接链接" title="pkgingresskube目录介绍的直接链接">​</a></h2><p>这部分内容较多，后续可自行针对感兴趣的部分进行精读。</p><ul><li><p><code>annotations</code></p><p>这里主要处理ingress注解的配置，在<code>NewAnnotationHandlerManager</code>方法里列出了一些已经支持的注解，每个注解的处理程序需要实现<code>AnnotationHandler</code>所定义的接口列表。</p></li><li><p><code>common</code></p><p>这里核心的文件为<code>controller.go</code>，主要做了一些资源的包装，以及定义了<code>IngressController</code>接口方法，其实现类有<code>pkg/ingress/kube/ingress/controller.go</code>和<code>pkg/ingress/kube/ingressv1/controller.go</code></p></li><li><p><code>configmap</code></p><p>这里主要为<code>ConfigMap</code>添加了<code>higress</code>的KV对，在<code>controller.go</code>中定义了<code>ItemController</code>接口，和前者提到的一样，这里也提供了相似的更新配置的方法<code>AddOrUpdateHigressConfig</code>，同样地，也是先获取当前的value值，并获取旧的value值，进行一个比对，比对结果可能为新增、更新、删除，分别执行对应的事件监听器里所定义的事件处理器，也就是<code>XDSUpdater</code>。</p></li><li><p><code>controller</code></p><p>在前面的介绍中，提到了很多次事件监听器，可能会有人疑问是怎么做资源监听的，资源监听的代码就位于本目录下了。这里可以着重介绍一下，事件监听的具体实现原理。</p><ol><li><p>定义了<code>Controller[lister any]</code>接口，其实现类为<code>CommonController</code>。
我们可以看一下这个实现结构体有哪些需要注意的字段。</p><p><strong>lister</strong>: 这个字段为any类型，会在<code>NewCommonController</code>方法里传入进来，点击查看该方法调用情况，可以发现传入该字段的都是各个资源的监听器，例如<code>ConfigMap</code>的监听器就是<code>client.KubeInformer().Core().V1().ConfigMaps().Lister().ConfigMaps(namespace)</code>，其它也是如此。
<strong>updateHandler</strong>: 这个字段为<code>func(util.ClusterNamespacedName)</code>类型，主要用于存储对应监听器lister所提供的更新或者新增事件处理器，存储代码如下：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">CommonController</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lister</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AddEventHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addOrUpdate </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClusterNamespacedName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">delete</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClusterNamespacedName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updateHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addOrUpdate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">delete</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">removeHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">delete</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>removeHandler</strong>: 同<strong>updateHandler</strong></p></li><li><p>接口方法除了刚刚介绍的<code>AddEventHandler</code>方法，还有个<code>Run</code>方法需要注意一下</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">CommonController</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lister</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> utilruntime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HandleCrash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ShutDown</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WaitForCacheSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HasSynced</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       IngressLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Failed to sync %s controller cache&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">typeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IngressLog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s cache has synced&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">typeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> wait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Until</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">worker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看有个<code>wait.Until</code>方法，用于每秒钟执行<code>c.worker</code>方法，直到接收到<code>stop</code>信号，方法调用链如下：<code>c.worker</code>-&gt;<code>c.processNextWorkItem()</code>-&gt;<code>c.onEvent(ingressNamespacedName)</code>-&gt;<code>c.updateHandler(obj)</code>，可以看出来当我们创建一个控制器，并为其注册了一个事件监听器以及事件处理器(updateHandler)，因此每秒钟会执行事件处理器，也就实现了监听的逻辑。</p></li></ol><p>也就是说，这个目录下主要定义了一个公共的控制器，可以节省大量代码的编写，我们在创建一个新的子控制器的时候，可以调用<code>NewCommonController</code>方法来实现监听逻辑。</p></li><li><p><code>http2rpc</code></p><p>代码较为简单，通过<code>NewCommonController</code>来创建<code>Http2RpcController</code>，并提供了<code>GetHttp2Rpc</code>方法。</p></li><li><p><code>ingress</code></p><p>Ingress控制器的核心代码逻辑，主要为前文提到的<code>ingress_config.go</code>所调用。部分内容在前文已经简单介绍过。</p></li><li><p><code>ingressv1</code></p><p>Ingress的API版本v1相关的控制器代码。</p></li><li><p><code>kingress</code></p><p>kingress相关的控制器代码。</p></li><li><p><code>mcpbridge</code></p><p>同<code>http2rpc</code>目录。</p></li><li><p><code>secret</code></p><p>同<code>http2rpc</code>目录。</p></li><li><p><code>util</code></p><p>工具包。</p></li><li><p><code>wasmplugin</code></p><p>同<code>http2rpc</code>目录。</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="higress-core流程图">higress-core流程图<a href="#higress-core流程图" class="hash-link" aria-label="higress-core流程图的直接链接" title="higress-core流程图的直接链接">​</a></h2><p>经过前面的源码分析，相信大家对higress核心逻辑已经有了初步的理解，后续可以针对自己感兴趣的部分，进行深入研究，其中会涉及到Kubernetes资源配置的核心逻辑以及Istio的基本掌握，当然，如果给它研究透了，对这些基本原理的理解将会更为深刻。</p><p>流程图如下：</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/higress-code0-7cade8cdd7da0af9b26d32509bf400c4.png" width="876" height="548" class="img_ev3q"></p><p>对于初始化配置控制器部分，可进一步绘画流程图。</p><p><img loading="lazy" alt="img1.png" src="/zh-cn/assets/images/higress-code1-ca225a577cf9fa2079101f80da3e10b2.png" width="914" height="384" class="img_ev3q"></p><p>关于事件监听部分，其流程图如下：</p><p><img loading="lazy" alt="img2.png" src="/zh-cn/assets/images/higress-code2-f370ace5f5ede0c4f87dab8e9acf1e2d.png" width="749" height="603" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>以上是对higress源码的初步分析，希望能够给用户以及开发者对higress有个基本的了解。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="在本地快速完成e2e测试并实现debug功能"><meta itemprop="keywords" content="higress"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/e2e-debug">教程：如何在本地进行higress调试和端到端测试</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-12-19T00:00:00.000Z" itemprop="datePublished">2023年12月19日</time> · <!-- -->阅读需 15 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">SJC</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景说明">背景说明<a href="#背景说明" class="hash-link" aria-label="背景说明的直接链接" title="背景说明的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="本地调试">本地调试<a href="#本地调试" class="hash-link" aria-label="本地调试的直接链接" title="本地调试的直接链接">​</a></h3><p>本地调试旨在在开发者的本地开发环境中识别、定位和修复代码中的错误（bug）。这个阶段的主要目标是确保单个模块或组件的正确性，以便更容易理解和解决问题。</p><p>开发者通常使用本地集成开发环境（IDE）或调试器来逐步执行代码、查看变量的值、观察程序的流程，并通过打断点来检查代码的执行过程。</p><p>本地调试是一个快速、迅速定位问题并进行修复的阶段，能够提供实时的反馈。它有助于确保代码的局部正确性，而不需要考虑整个系统的交互。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="端到端测试">端到端测试<a href="#端到端测试" class="hash-link" aria-label="端到端测试的直接链接" title="端到端测试的直接链接">​</a></h3><p>e2e测试是一种端到端的测试，是一种全面的测试方法，用于验证整个软件系统在真实环境中的功能和性能。它模拟用户的实际使用情况，确保整个系统的各个部分正确协同工作，以达到用户期望的功能。</p><p>端到端测试关注整个系统的集成和交互，旨在发现不同组件之间的问题以及在实际使用场景中可能出现的 bug。这有助于确保系统在生产环境中的稳定性和可靠性。</p><p>在higress中，e2e测试的主要流程可用下图来表示：</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug0-e9db11f70bb082a52732b7b318a076a7.png" width="1083" height="133" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="弊端">弊端<a href="#弊端" class="hash-link" aria-label="弊端的直接链接" title="弊端的直接链接">​</a></h3><ul><li><p>在本地开发的过程中，我们需要频繁的进行e2e测试，但是每次都要重新构建镜像、加载镜像、安装higress、运行e2e测试，这样的过程非常耗时，因此我们希望尽量地减少这些过程，复用测试环境以提高开发效率。</p></li><li><p>当e2e运行的时候出现问题，我们希望能够快速定位问题，这就需要在e2e测试中实现本地调试的功能。</p></li><li><p>另外，通常开发wasm插件的时候是不需要重新构建镜像的，只需要复用测试环境即可。然而，当涉及到higress-core组件代码(higress核心代码)修改的时候，就需要重新构建镜像，频繁地修改代码、重新构建镜像以运行e2e测试，这样开发效率就会大大降低。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="#解决方案" class="hash-link" aria-label="解决方案的直接链接" title="解决方案的直接链接">​</a></h3><ul><li>不涉及higress-core组件修改</li></ul><p>可分为端到端测试的优化和在端到端测试中实现本地调试的功能，端到端优化可采用实现测试环境复用的方法，通过修改makefile文件来减少环境的创建等开销。</p><p>而在端到端测试中实现本地调试的功能，可通过Goland来实现，提前准备好测试环境，修改e2e测试的部分代码来减少e2e环境创建的开销，更加方便的实现debug功能。</p><ul><li>涉及higress-core组件修改</li></ul><p>可在本地启动higress-core组件，并使其能够与kind集群中的discovery、gateway等组件进行交互。</p><p>例如在涉及到higress-config的ConfigMap修改的时候，其流程大致如下：</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug5-cbdc082e404661537dfc9eccfe2f35a8.png" width="1076" height="177" class="img_ev3q"></p><p>可以发现，只需要修改higress-core容器与discovery容器之间的xds协议通信地址，使其能够与本地的higress-core容器进行交互，其是注册在grpc服务上的，因此只需要修改xds地址为本地的grpc服务地址即可。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="具体实现">具体实现<a href="#具体实现" class="hash-link" aria-label="具体实现的直接链接" title="具体实现的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="端到端测试优化">端到端测试优化<a href="#端到端测试优化" class="hash-link" aria-label="端到端测试优化的直接链接" title="端到端测试优化的直接链接">​</a></h3><p>通过makefile来完成，包含启动系列环境和执行e2e测试。</p><p>以运行插件测试为例，其make命令如下：</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress-wasmplugin-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token target symbol" style="color:#36acaa">higress-wasmplugin-test</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tools/kind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> delete-cluster create-cluster docker-build kube-load-image install-dev-wasmplugin run-higress-e2e-test-wasmplugin delete-cluster</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>开发者首次运行环境可先删除最后一个<code>delete-cluster</code>的操作，第二次运行e2e测试的时候可以删除前面的操作，只保留<code>run-higress-e2e-test-wasmplugin</code>的操作，这样就可以减少很多时间。</p><p>然而make命令不支持添加到goland里面实现debug功能，运行出错的时候也不方便定位问题，更推荐使用下面这个方法。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="在e2e中实现本地调试">在e2e中实现本地调试<a href="#在e2e中实现本地调试" class="hash-link" aria-label="在e2e中实现本地调试的直接链接" title="在e2e中实现本地调试的直接链接">​</a></h3><p>通过Goland来完成，提前准备好环境，修改Goland启动参数来完成本地调试。</p><ul><li>e2e测试之前的准备</li></ul><p>根据各自的需求来定制环境，如果测试环境中需要用到higress的controller、gateway等组件，需要提前本地安装好环境，安装教程可参考<a href="https://higress.io/zh-cn/docs/user/quickstart/" target="_blank" rel="noopener noreferrer">这里</a>，或者参考端到端测试优化步骤来准备好测试环境。</p><p>安装好higress后，可以使用如下命令来查看higress的pod是否正常运行：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods --all-namespaces</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>显示结果如下图所示：</p><p><img loading="lazy" alt="1.png" src="/zh-cn/assets/images/e2e-debug1-6d4ad979b78fd26ceedc43b24fc18b3c.png" width="980" height="136" class="img_ev3q"></p><p>都显示Running状态，说明higress已经正常运行。</p><ul><li>e2e的flag修改</li></ul><p>在<code>test/e2e/conformance/utils/flags</code>目录下，有一个<code>flags.go</code>文件，里面定义了e2e测试的flag：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IngressClassName     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ingress-class&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;higress&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Name of IngressClass to use for tests&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ShowDebug            </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;debug&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Whether to print debug logs&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CleanupBaseResources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;cleanup-base-resources&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Whether to cleanup base test resources after the run&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SupportedFeatures    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;supported-features&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Supported features included in conformance tests suites&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ExemptFeatures       </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;exempt-features&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Exempt Features excluded from conformance tests suites&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IsWasmPluginTest     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;isWasmPluginTest&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Determine if run wasm plugin conformance test&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WasmPluginType       </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;wasmPluginType&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;GO&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Define wasm plugin type, currently supports GO, CPP&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WasmPluginName       </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;wasmPluginName&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Define wasm plugin name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IsEnvoyConfigTest    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Bool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;isEnvoyConfigTest&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Determine if run envoy config conformance test&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可临时修改这些flag的初始值，也可以在Goland编辑器中定义启动参数，例如设置<code>IsWasmPluginTest</code>为true可只运行wasm插件的e2e测试。</p><p>修改好flag之后，我们就可以在Goland中通过debug的方式运行e2e测试。可先在如下位置添加一个断点，等待e2e环境准备完毕：</p><p><img loading="lazy" alt="2.png" src="/zh-cn/assets/images/e2e-debug2-de7c59fff6871ae104cb9f1fdbae9f65.png" width="1335" height="987" class="img_ev3q"></p><p>e2e测试在前期环境准备的过程中会创建一些namespace并启动一些pod，可以手动查看一下pod的启动情况。</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug3-4d25bee1f70fb8ae0a0a90deee54244d.png" width="1201" height="605" class="img_ev3q"></p><p>在这张图里面，除了我们提前安装好的higress组件之外，还有一些其他的pod，这些pod是e2e测试过程中创建的，如果有些pod在本地e2e测试中用不到，可手动修改代码来减少前期环境的准备时间。</p><blockquote><p>注意：如果设置了cleanup-base-resources为false，那么e2e测试结束之后，这些pod不会被删除，但是重启的时候会报错，例如：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Pod &quot;consul-standlone&quot; is invalid: spec: Forbidden: pod updates may not change fields other than `spec.containers[*].image`, `spec.initContainers[*].image`, `spec.activeDeadlineSeconds`, `spec.tolerations` (only additions to existing tolerations) or `spec.terminationGracePeriodSeconds` (allow it to be set to 1 if it was previously negative)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><blockquote><p>建议设置为true，每次测试完需要等待pod的销毁，然后重新测试，这些过程一般很快，也可以修改代码来减少一些pod的创建。</p></blockquote><ul><li>e2e测试环境优化</li></ul><p>例如只需要higress环境，而不需要<code>higress-conformance-infra</code>,<code>higress-conformance-app-backend</code>等namespace环境，可以手动在如下几行代码里添加注释，来跳过这些环境的创建，然后测试中只用到了higress的组件：</p><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug4-263420d802513c11800de3ce76b453f8.png" width="1372" height="984" class="img_ev3q"></p><p>在这里，我只需要运行<code>EnvoyConfigTracing</code>的Test测试，它只跟higress和higress-conformance-infra有关，注释掉了其他namespace的准备环境，可以看到e2e测试不到1s就结束了。</p><p>如果需要其他namespace的环境，而不需要nacos/consul等环境，可以在suite的New方法里找到以下代码块，根据需要进行注释：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// apply defaults</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> suite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BaseManifests </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    suite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BaseManifests </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;base/manifests.yaml&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;base/consul.yaml&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;base/eureka.yaml&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;base/nacos.yaml&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;base/dubbo.yaml&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>解决好e2e测试的环境相关问题，我们就可以在Goland里添加自己想要的断点，来debug测试用例了。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higress-core本地调试e2e测试">higress-core本地调试+e2e测试<a href="#higress-core本地调试e2e测试" class="hash-link" aria-label="higress-core本地调试+e2e测试的直接链接" title="higress-core本地调试+e2e测试的直接链接">​</a></h3><ul><li>首先在本地启动higress-core组件，需要修改其启动参数，与正常部署的启动参数保持一致，可参考如下配置Goland的启动参数：</li></ul><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug6-19e1a126b7ce35334a9c2d73da8a8b77.png" width="1018" height="814" class="img_ev3q"></p><ul><li>查找自己的本机非回环网卡的ip地址，例如我使用wlo0网卡，也就是192.168.0.189</li></ul><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug7-5aee459287eee78b4f81c389416b186c.png" width="1022" height="190" class="img_ev3q"></p><ul><li>修改xds协议地址，运行<code>kubectl edit cm higress-config -n higress-system</code>，将其修改本地的grpc服务地址，如图：</li></ul><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug8-de3b41a3f2a5259600b86fe1e3a7a638.png" width="706" height="161" class="img_ev3q"></p><p>将其中的127.0.0.1:15051修改为192.168.0.189:15051，保存退出。</p><ul><li>重启controller和gateway deployment，使其能够重新加载配置:</li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment higress-gateway -n higress-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout restart deployment higress-controller -n higress-system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug9-3a14da3112f41d230e6b7112658ba74e.png" width="1016" height="238" class="img_ev3q"></p><ul><li>重启成功后可以先运行一下简单的e2e测试，比如http route等，测试是否能正常连通gateway，关于ConfigMap部分，我这里给本地higress-core添加了一个global-option的配置，此时kind的core组件还没有该配置，按照前面步骤启动本地higress-core并修改xds地址重启负载之后，运行相关的e2e测试，可以看到测试通过，本地higress-core日志以及kind上的discovery日志如下：</li></ul><p><img loading="lazy" alt="img.png" src="/zh-cn/assets/images/e2e-debug10-b495481ce79e3c61606be79a1baee0fb.png" width="1824" height="858" class="img_ev3q"></p><p>通过本地higress-core日志可以看到ads成功推送出去envoyfilter配置文件给discovery，而discovery日志则显示lds/rds/cds等成功将配置文件推送给gateway。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hgctl-code-debug的使用">hgctl code-debug的使用<a href="#hgctl-code-debug的使用" class="hash-link" aria-label="hgctl code-debug的使用的直接链接" title="hgctl code-debug的使用的直接链接">​</a></h2><p>hgctl已经推出code-debug的功能，会自动修改xds地址，使其能够与本地的higress-core进行交互。这里需要使用hgctl来安装higress，目前code-debug只支持local-k8s的profile。</p><ul><li>hgctl安装higress</li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hgctl </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> --set </span><span class="token assign-left variable" style="color:#36acaa">profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">local-k8s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>等待安装完成后，手动查看一下是否启动成功。</p><ul><li>启动本地higress-core</li></ul><p>修改Goland启动参数为<code>serve --kubeconfig=/root/.kube/config</code>(改为自己的home目录)，然后启动higress-core，等待higress-core启动成功。</p><ul><li>开启code-debug</li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hgctl code-debug start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>查看controller和gateway的pod是否重启成功，如果重启成功，说明code-debug已经生效。</p><ul><li>其他环境准备</li></ul><p>在后面的步骤上涉及到Ingress资源，这里需要准备一下Ingress资源，运行如下命令：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f - </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: higress-conformance-infra</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    higress-conformance: infra</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: higress-conformance-infra</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    app: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      port: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      targetPort: 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: higress-conformance-infra</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    app: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  replicas: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      app: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        app: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - name: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        # From https://github.com/kubernetes-sigs/ingress-controller-conformance/tree/master/images/echoserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        image: higress-registry.cn-hangzhou.cr.aliyuncs.com/higress/echoserver:v20221109-7ee2f3e</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - name: POD_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">              fieldPath: metadata.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - name: NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">              fieldPath: metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            cpu: 10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: higress-conformance-infra-configmap-global-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: higress-conformance-infra</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  ingressClassName: higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - host: &quot;foo.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      http:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        paths:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          - pathType: Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            path: &quot;/foo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">              service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                name: infra-backend-v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                port:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">                  number: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>调试higress-core</li></ul><p>以ConfigMap的gzip(位于pkg/ingress/kube/configmap/gzip.go)为例，修改<code>NewDefaultGzip</code>方法，将<code>Enable</code>的默认值修改为true，然后重启higress-core。</p><p>在重启之前，先运行如下shell命令，启动envoy查看面板：</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hgctl dashboard envoy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>访问http://localhost:15000/config_dump，使用Ctrl+F搜索<code>compression_level</code>，可以看到查找结果为空，说明gzip配置还没有生效。</p><p>接下来重启higress-core，等待higress-core重启成功，再次访问http://localhost:15000/config_dump，使用Ctrl+F搜索<code>compression_level</code>，可以看到查找结果不为空，说明gzip配置已经生效。</p><ul><li>关闭code-debug</li></ul><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hgctl code-debug stop</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><ol><li>本地调试和e2e测试是开发过程中必不可少的环节，通过本文的介绍，我们可以更加方便的进行本地调试和e2e测试，提高开发效率。</li><li>涉及到higress-core组件修改的时候，我们可以通过修改xds地址并本地启动higress-core，而不需要频繁地修改代码、重新构建镜像以运行e2e测试，并且还能调试higress-core组件的代码。</li><li>higress后续会推出一些新功能，实现e2e测试的拆分，主要会分为准备环境，运行测试以及清除环境等，灵活性更高。</li></ol></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="Higress 招聘信息"><meta itemprop="keywords" content="higress,hiring"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/hring">Higress 团队招募小伙伴加入～</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-11-17T00:00:00.000Z" itemprop="datePublished">2023年11月17日</time> · <!-- -->阅读需 6 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">澄潭</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="加入higress的商业化team">加入Higress的商业化Team<a href="#加入higress的商业化team" class="hash-link" aria-label="加入Higress的商业化Team的直接链接" title="加入Higress的商业化Team的直接链接">​</a></h2><p>我们商业化Team有充足的HC，欢迎加入👏，联系方式：微信(nomadao)  邮箱(<a href="mailto:zty98751@alibaba-inc.com" target="_blank" rel="noopener noreferrer">zty98751@alibaba-inc.com</a>)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="团队介绍">团队介绍<a href="#团队介绍" class="hash-link" aria-label="团队介绍的直接链接" title="团队介绍的直接链接">​</a></h3><p>Higress团队属于阿里云云原生中间件团队。</p><p>阿里云云原生中间件团队负责分布式软件基础设施，为阿里云上万家企业提供如微服务引擎、分布式事务、EDAS等分布式基础服务，加速企业上云的进程和创新速度。同时，云原生中间件团队也服务着阿里集团众多核心业务和场景，是支撑双十一狂欢节的核心团队之一。</p><p>在这里，有非常优秀的中间件产品和场景以及企业互联网架构平台，服务上万家阿里云的企业，支持大规模电商交易业务场景。</p><p>在这里，你会参与到全球优秀开源项目（如 Apache Dubbo、RocketMQ、Nacos、Sentinel、Seata、Arthas、Tengine、Istio、Envoy、OpenSergo、Higress）和阿里云核心商业化产品（微服务引擎 MSE、企业级分布式应用服务 EDAS、应用实时监控服务ARMS）研发工作中，一同拓展技术的边界，既赋能阿里巴巴集团，更服务广泛的开发者用户。</p><p>在这里，你会参与到中间件、微服务、Serverless 等前沿的技术研发与探索中来；你也会与全球优秀开源产品创始人等组成的明星团队一起工作。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="负责工作">负责工作<a href="#负责工作" class="hash-link" aria-label="负责工作的直接链接" title="负责工作的直接链接">​</a></h3><ol><li>参与阿里云商业版Higress（MSE云原生网关）的产品研发</li><li>参与Higress开源的产品研发和社群运营</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="职位要求">职位要求<a href="#职位要求" class="hash-link" aria-label="职位要求的直接链接" title="职位要求的直接链接">​</a></h3><ol><li>3年以上产品研发工作经验，熟练使用Go或C++，有云原生相关产品研发经验者优先。</li><li>有Higress/Envoy/Istio/Nginx开源贡献和开发经验者优先。</li><li>具备出色的项目管理协调和业务规划能力，有团队合作精神，并能借助各方力量推动规则、制度等落地。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="加入higress的开源team">加入Higress的开源Team<a href="#加入higress的开源team" class="hash-link" aria-label="加入Higress的开源Team的直接链接" title="加入Higress的开源Team的直接链接">​</a></h2><p>Higress为参与贡献的同学设计了几个可认领的头衔，达到一定贡献要求，即可在Higress官网提<a href="https://github.com/higress-group/higress-group.github.io/blob/main/i18n/zh-cn/docusaurus-plugin-content-docs/current/developers/developers_dev.md" target="_blank" rel="noopener noreferrer">PR</a>的方式认领。</p><p><strong>头衔本身是一种荣誉象征，每一位参与Higress的贡献者在开源社区的地位都是平等的</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="member-头衔">Member 头衔<a href="#member-头衔" class="hash-link" aria-label="Member 头衔的直接链接" title="Member 头衔的直接链接">​</a></h3><p><strong>条件：</strong></p><ul><li>获得 8 个完成 issue 的积分（easy +1，normal +2，challenge +4）</li></ul><blockquote><p>Higress开源社区为每个可认领（help wanted标签）的issue都标记了难度标签：简单(level/easy)，普通(level/normal)，有挑战(level/challenge)，完成issue后可以获得对应积分</p></blockquote><ul><li>贡献代码（包含文档）DIFF 行数（包含增删）达到 500+</li></ul><blockquote><p>不仅只有贡献代码，在Higress<a href="https://github.com/higress-group/higress-group.github.io" target="_blank" rel="noopener noreferrer">官网仓库</a>贡献文档，也可以满足此要求</p></blockquote><ul><li>在社区周会进行 1 次主题分享</li></ul><blockquote><p>重点不是分享的内容，是通过分享让大家认识你</p></blockquote><p><strong>申请方式：</strong></p><p>直接提PR申请</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="reviewer-头衔">Reviewer 头衔<a href="#reviewer-头衔" class="hash-link" aria-label="Reviewer 头衔的直接链接" title="Reviewer 头衔的直接链接">​</a></h3><p><strong>条件：</strong></p><ul><li>满足Member条件</li><li>在SIG的核心 <a href="https://github.com/alibaba/higress/issues/547" target="_blank" rel="noopener noreferrer">issue</a> 中做出贡献</li></ul><p><strong>申请方式：</strong></p><p>由Approvers/Maintainer提名后，提PR申请</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="approver-头衔">Approver 头衔<a href="#approver-头衔" class="hash-link" aria-label="Approver 头衔的直接链接" title="Approver 头衔的直接链接">​</a></h3><p><strong>条件：</strong></p><ul><li>满足Reviewer条件</li><li>主导一个SIG，组织并推进核心issue的tasklist完成</li></ul><p><strong>申请方式：</strong></p><p>由Maintainer提名后，提PR申请</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="maintainer-头衔">Maintainer 头衔<a href="#maintainer-头衔" class="hash-link" aria-label="Maintainer 头衔的直接链接" title="Maintainer 头衔的直接链接">​</a></h3><p>Maintainer是对Higress项目（包括Higress下的项目）的演进和发展做出显著贡献的个人。在社区中具有有目共睹的影响力，能够代表Higress参加重要的社区会议和活动。</p><p><strong>条件：</strong></p><ul><li>满足Approver条件</li><li>主导多个SIG，组织并推进核心issue的tasklist完成</li><li>积极参与开源社区的日常工作：引导新人开发，用户问题解答等</li></ul><p><strong>申请方式：</strong></p><p>由2名Maintainer提名后，提PR申请</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="已获得头衔名单">已获得头衔名单<a href="#已获得头衔名单" class="hash-link" aria-label="已获得头衔名单的直接链接" title="已获得头衔名单的直接链接">​</a></h3><p><strong>注：排名按 github id 首字母</strong></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="higress-maintainers">Higress Maintainers<a href="#higress-maintainers" class="hash-link" aria-label="Higress Maintainers的直接链接" title="Higress Maintainers的直接链接">​</a></h4><table><thead><tr><th>姓名</th><th>github</th><th>组织</th></tr></thead><tbody><tr><td>董艺荃</td><td><a href="https://github.com/CH3CHO" target="_blank" rel="noopener noreferrer">CH3CHO</a></td><td>Trip.com</td></tr><tr><td>耿蕾蕾</td><td><a href="https://github.com/gengleilei" target="_blank" rel="noopener noreferrer">gengleilei</a></td><td>Alibaba</td></tr><tr><td>张添翼</td><td><a href="https://github.com/johnlanni" target="_blank" rel="noopener noreferrer">johnlanni</a></td><td>Alibaba</td></tr><tr><td>范扬</td><td><a href="https://github.com/SpecialYang" target="_blank" rel="noopener noreferrer">SpecialYang</a></td><td>Alibaba</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="higress-approvers">Higress Approvers<a href="#higress-approvers" class="hash-link" aria-label="Higress Approvers的直接链接" title="Higress Approvers的直接链接">​</a></h4><table><thead><tr><th>姓名</th><th>github</th><th>组织</th></tr></thead><tbody><tr><td>吴新军</td><td><a href="https://github.com/2456868764" target="_blank" rel="noopener noreferrer">2456868764</a></td><td>-</td></tr><tr><td>刘训灼</td><td><a href="https://github.com/Xunzhuo" target="_blank" rel="noopener noreferrer">Xunzhuo</a></td><td>Tencent</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="higress-reviewers">Higress Reviewers<a href="#higress-reviewers" class="hash-link" aria-label="Higress Reviewers的直接链接" title="Higress Reviewers的直接链接">​</a></h4><table><thead><tr><th>姓名</th><th>github</th><th>组织</th></tr></thead><tbody><tr><td>凌轶群</td><td><a href="https://github.com/Lynskylate" target="_blank" rel="noopener noreferrer">Lynskylate</a></td><td>Pdd Holdings Inc</td></tr><tr><td>刘晓瑞</td><td><a href="https://github.com/rinfx" target="_blank" rel="noopener noreferrer">rinfx</a></td><td>Alibaba</td></tr><tr><td>赵炳堃</td><td><a href="https://github.com/sjtuzbk" target="_blank" rel="noopener noreferrer">sjtuzbk</a></td><td>Alibaba</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="higress-members">Higress Members<a href="#higress-members" class="hash-link" aria-label="Higress Members的直接链接" title="Higress Members的直接链接">​</a></h4><table><thead><tr><th>姓名</th><th>github</th><th>组织</th></tr></thead><tbody><tr><td>李强林</td><td><a href="https://github.com/Charlie17Li" target="_blank" rel="noopener noreferrer">Charlie17Li</a></td><td>ZJU-SEL</td></tr><tr><td>封宇腾</td><td><a href="https://github.com/Fkbqf" target="_blank" rel="noopener noreferrer">Ffyyt</a></td><td>XUPT</td></tr><tr><td>田亚涛</td><td><a href="https://github.com/Hinsteny" target="_blank" rel="noopener noreferrer">Hinsteny</a></td><td>Ant</td></tr><tr><td>宋鹏远</td><td><a href="https://github.com/songpengyuan" target="_blank" rel="noopener noreferrer">songpengyuan</a></td><td>Okki.com</td></tr><tr><td>赵伟基</td><td><a href="https://github.com/vikizhao156" target="_blank" rel="noopener noreferrer">vikizhao156</a></td><td>SJTU</td></tr><tr><td>韦鑫</td><td><a href="https://github.com/weixinx" target="_blank" rel="noopener noreferrer">WeixinX</a></td><td>NUAA</td></tr></tbody></table></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="支持了 Gateway API 标准，还有全新的运维/开发工具，以及我们新的开源征程"><meta itemprop="keywords" content="higress,ingress,Gateway API"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/release-1.3">Higress 开源一周年：新版本，新标准，新工具，新征程</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-11-04T00:00:00.000Z" itemprop="datePublished">2023年11月4日</time> · <!-- -->阅读需 19 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">澄潭</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="历程回顾">历程回顾<a href="#历程回顾" class="hash-link" aria-label="历程回顾的直接链接" title="历程回顾的直接链接">​</a></h2><p><img loading="lazy" src="https://github.com/johnlanni/higress-group.github.io/assets/6763318/b5f3ee1b-d53a-4fbb-8d4a-82427ebdfe40" alt="image" class="img_ev3q"></p><p>Higress 开源一年时间，一共发布了 18 个 release 版本，收获了 40 多位社区贡献者和 1800+ star，上图是这一年过来达成的一些关键的里程碑。</p><p>前面半年通过集成开源生态，打磨开源版本稳定性，并在发布 1.0 GA 版本后，社区又马不停蹄发布了 1.1 和 1.2 两个重要版本，实现了非 K8s 部署，Knative 适配等核心能力。</p><p>Higress 1.3 版本已经正式发布，除了增加的新功能，已有能力也在大量社区用户反馈的过程中不断完善改进，这个版本同时标志着 1.x 进入可以大规模生产使用的状态。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新版本功能速览">新版本：功能速览<a href="#新版本功能速览" class="hash-link" aria-label="新版本：功能速览的直接链接" title="新版本：功能速览的直接链接">​</a></h2><p>自发布 1.2 版本过去了一个多月时间，1.3 版本正式发布，带来两个全新能力：</p><ul><li>新标准：支持最新版本 Gateway API 标准，并且具备从 Ingress 平滑渐进演进，以及对接多种服务发现机制的能力</li><li>新工具：正式 release 了 hgctl (Higress Crontroller) 这个 &quot;All in one&quot; 的新工具，不仅可以替代 Helm 实现更简易的安装，还提供了 WASM 插件开发工具包，以及网关配置检查等丰富功能</li></ul><p>除了这两个核心功能外，还有一些实用功能：</p><ol><li>提供了 Higress Admin Java SDK，可以统一对接 K8s 和非 K8s 环境，管理域名/路由等配置</li><li>提供了 OIDC 插件，支持对接 Keycloak/Okta 等第三方身份认证系统</li><li>Higress Console 的易用性和安全性提升，不再通过路由暴露，支持界面初始化/修改密码</li></ol><p>与此同时，Higress 开源社区已经开始准备踏上一段全新的开源征程...</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新标准支持最新版-gateway-api">新标准：支持最新版 Gateway API<a href="#新标准支持最新版-gateway-api" class="hash-link" aria-label="新标准：支持最新版 Gateway API的直接链接" title="新标准：支持最新版 Gateway API的直接链接">​</a></h2><p>Gateway API 在 11 月 1 日正式发布了 1.0.0 版本，其中 GatewayClass, Gateway, HTTPRoute 这三个 API正式宣布 GA，发布了 v1 版本：gateway.networking.k8s.io/v1。</p><p>目前 Higress 已经可以支持这些最新版本的 API 配置，只需在安装/升级 Higress 时配置开启 Gateway API：</p><ul><li>使用 Helm ：通过参数 <code>--set global.enableGatewayAPI=true</code></li><li>使用 Hgctl ：通过命令行参数或者 install.yaml 中配置 <code>global.enableGatewayAPI=true</code></li></ul><p>首先创建 GatewayClass 资源：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gateway.networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GatewayClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">controllerName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;higress.io/gateway-controller&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接着在安装 Higress 的命名空间下，创建 Gateway 资源，通过 gatewayClassName 关联上面创建的 GatewayClass 资源，指定由 Higress 来管理此 Gateway 配置，下面为域名同时配置了 HTTP 和 HTTPS 入口，并为 HTTPS 入口配置了证书：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gateway.networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gatewayClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">listeners</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foobar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hostname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*.foobar.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">allowedRoutes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">namespaces</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> All</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foobar</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">https</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hostname</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*.foobar.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTPS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">allowedRoutes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">namespaces</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> All</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">certificateRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> wildcard</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">foobar</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Terminate        </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因为上面 Gateway 通过 allowedRoutes 配置了允许所有命名空间的路由来关联，所以这里在 default 命名空间下创建 HTTPRoute，关联上面创建的 Gateway，即可定义域名下的具体路由：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gateway.networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTPRoute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foobar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parentRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hostnames</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;www.foobar.com&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">matches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PathPrefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /foo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">backendRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5678</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以上就是 Gateway API 的一个简单用法示例，Gateway API 还有很多功能和玩法，后面 Higress 公众号/博客会出一个系列进行系统分享和介绍。</p><p>欢迎结合<a href="https://gateway-api.sigs.k8s.io/reference/spec/" target="_blank" rel="noopener noreferrer">官方 API 文档</a>，并使用 hgctl （获取方式见下文）在自己电脑上安装一个 local-k8s 模式的 Higress，来开启对这一新标准的探索：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 一键安装, 交互式命令选择第一种安装模式 local-k8s，将默认安装 Gateway API CRD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hgctl </span><span class="token function" style="color:#d73a49">install</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="多种服务发现能力">多种服务发现能力<a href="#多种服务发现能力" class="hash-link" aria-label="多种服务发现能力的直接链接" title="多种服务发现能力的直接链接">​</a></h3><p>在 Ingress API 标准下，Higress 对接多种服务发现能力是独树一帜的，在 Gateway API 标准下， Higress 仍就保持了这一能力优势：</p><p>首先通过 McpBridge 资源，可以定义多种服务发现机制：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> McpBridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">registries</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nacosGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DEFAULT_GROUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8848</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nacos2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">zk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2181</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> zookeeper      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">eureka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8761</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> eureka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">domain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">consulDatacenter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dc1      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> consul</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建一个 HTTPRoute 资源，可以同时对接 K8s 服务，和注册中心的服务，并实现灰度路由能力：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> gateway.networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTPRoute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">parentRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">matches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> PathPrefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">backendRefs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">provider.DEFAULT</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">GROUP.public.nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">group</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.higress.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">weight</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">90</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5678</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">weight</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>和 K8s 服务不同的是，这里 group 为 <code>networking.higress.io</code> 的服务并不需要提前创建 CRD 资源，这更符合传统微服务用户的习惯，即服务模型不需要提前创建，是通过服务节点注册自动生成。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ingress-api-和-gateway-api-之间如何选择">Ingress API 和 Gateway API 之间如何选择<a href="#ingress-api-和-gateway-api-之间如何选择" class="hash-link" aria-label="Ingress API 和 Gateway API 之间如何选择的直接链接" title="Ingress API 和 Gateway API 之间如何选择的直接链接">​</a></h3><p>有了 Gateway API，是否应该立即抛弃 Ingress API？</p><p>只有最合适的，没有最好的。Gateway API 虽然为更多网关能力做了标准化，但 CRD 的种类和复杂度也增加了，相比之下对于大部分简单用例场景，Ingress API 更加简单易用。</p><p>对于以下场景，采用 Gateway API 替代 Ingress API 会带来很大帮助：</p><ul><li>大型团队划分了 SRE 角色和业务研发角色，由 SRE 通过 Gateway 资源统一管理站点域名和证书，由业务研发通过 HTTPRoute 资源管理业务路由，实现职责划分，权限收敛</li><li>创建的路由和 Service 有不在一个命名空间的需求，可以借助 ReferenceGrant 资源实现</li><li>有大量证书需要集中式管理，不希望将证书 Secret 同步到 Ingress 所在命名空间，带来安全风险</li></ul><p>Gateway API 的另一个好处是对于更多功能的标准化定义，我们建议遇到实际需要再转换到这个新的标准，而不必盲目跟随。</p><p>Higress 支持 Gateway API 和 Ingress API 混合使用，Gateway API 下的域名路由将比 Ingress API 优先匹配，和 Ingress 相同资源名称的 HTTPRoute 还会继承 WASM 插件配置，这样用户可以按需采用 Gateway API，平滑地完成从 Ingress API 向 Gateway API 的演进，无需焦虑 API 标准升级过程中产生业务损失。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新工具all-in-one-的-hgctl">新工具：All in one 的 hgctl<a href="#新工具all-in-one-的-hgctl" class="hash-link" aria-label="新工具：All in one 的 hgctl的直接链接" title="新工具：All in one 的 hgctl的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="替代-helm-用于安装升级">替代 Helm 用于安装/升级<a href="#替代-helm-用于安装升级" class="hash-link" aria-label="替代 Helm 用于安装/升级的直接链接" title="替代 Helm 用于安装/升级的直接链接">​</a></h3><p>在 K8s 下用 Helm 安装/升级组件很方便，但在 Higress 的场景下仍然存在一些问题：</p><ol><li>无法支持非 K8s 场景下的安装/升级</li><li>Higress 有很多安装参数，进行升级等操作时不好维护，使用<code>reuse-values</code> 有一些副作用，且容易误操作</li><li>无法管理 CRD 跟随版本更新，需要手动更新</li></ol><p>Higress 借鉴了 istio 的 istioctl，提供了 hgctl 这个命令行工具解决了上述问题，通过以下命令即可安装 hgctl</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 下载最新版 Hgctl：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -Ls https://raw.githubusercontent.com/alibaba/higress/main/tools/hack/get-hgctl.sh </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">VERSION</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">latest </span><span class="token function" style="color:#d73a49">bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>hgctl 集成了三种 Higress 安装模式，并统一了升级/运维操作：</p><ol><li>本地 K8s 环境（例如kind/k3s）模式</li><li>正式 K8s 环境模式</li><li>不依赖 K8s 的纯 Docker 环境模式</li></ol><p>直接执行 <code>hgctl install</code> 命令即可选择任意模式进行安装</p><p>安装配置文件将存至 <code>~/.hgctl/profiles/install.yaml</code> 目录下，查看该文件内容如下：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">charts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">higress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 安装文件的 helm repo 地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//higress.io/helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">charts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 执行 hgctl upgrade 时将自动更新至最新版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">console</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 开启可观测组件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">o11YEnabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 控制台实例数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">controller</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 控制面组件实例数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">gateway</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 数据面组件实例数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 开启 Gateway API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enableGatewayAPI</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 开启 Istio API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enableIstioAPI</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 设置监听的 ingress class</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ingressClass</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 安装模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">install</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 安装命名空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> higress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 配置传递给 helm 的 values 参数 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">profile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修改上面文件的内容后，执行<code>hgctl upgarde</code>即可实现参数变更生效，如果只想修改参数，不想触发版本升级，可以将 version 参数固定为当前版本。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="wasm-插件开发工具包">WASM 插件开发工具包<a href="#wasm-插件开发工具包" class="hash-link" aria-label="WASM 插件开发工具包的直接链接" title="WASM 插件开发工具包的直接链接">​</a></h3><p>为了标准化并简化 WASM 插件的开发/编译/测试/发布，Higress 提供了 <code>hgctl plugin</code> 这一子命令，使用方式为：</p><ol><li><code>hgctl plugin init</code>: 初始化 Golang WASM 插件项目，包括三个文件；</li><li>用户编写 WASM 插件逻辑；</li><li><code>hgctl plugin build --output-type files</code>: 构建 WASM 插件，在本地输出构建产物；</li><li><code>hgctl plugin test: 使用 docker compose</code> 在本地测试 WASM 插件，如需修改插件逻辑，则返回第 2 步；</li><li><code>hgctl plugin build --output-type image</code>: 构建 WASM 插件作为 OCI 镜像上传至镜像仓库；</li><li><code>hgctl plugin install</code>: 安装 WASM 插件，可以通过本地的 yaml 文件或插件项目进行安装。</li></ol><p>另外，若需要查看已安装的插件，则使用 <code>hgctl plugin ls</code>；若需要操作插件配置，则使用 <code>hgctl plugin config</code></p><p>通过这个工具，可以在构建 WASM 插件的同时，根据配置代码自动生成插件的配置说明文档，以及包含插件配置约束的元信息文件，这些内容都将和 WASM 文件一起放入 OCI 镜像制品中，通过镜像方式进行版本管理和分发。这一机制是后续 Higress 建设 WASM 插件市场的基石。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="其他功能">其他功能<a href="#其他功能" class="hash-link" aria-label="其他功能的直接链接" title="其他功能的直接链接">​</a></h3><p>另外介绍两个实用的子命令：</p><ol><li><code>hgctl dashboard</code>: 用于呼出 UI 界面，例如 Higress 控制台，直接通过 <code>hgctl dashboard console</code> 即可打开</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  $ hgctl dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Access to Higress web UIs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hgctl dashboard </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hgctl dashboard </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">command</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Aliases:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dashboard, dash, d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Available Commands:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    console     Open Console web UI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    controller  Open Controller debug web UI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    envoy       Open Envoy admin web UI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    grafana     Open Grafana web UI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prometheus  Open Prometheus web UI</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li><code>hgctl gateway-config</code>: 用于查看数据面的 envoy 配置，可以快速验证配置是否正确下发</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  $ hgctl gateway-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Retrieve information about Higress Gateway Configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hgctl gateway-config </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">command</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Aliases:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gateway-config, gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Available Commands:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    all         Retrieves all Envoy xDS resources from the specified Higress Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bootstrap   Retrieves bootstrap Envoy xDS resources from the specified Higress Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cluster     Retrieves cluster Envoy xDS resources from the specified Higress Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endpoint    Retrieves endpoint Envoy xDS resources from the specified Higress Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listener    Retrieves listener Envoy xDS resources from the specified Higress Gateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    route       Retrieves route Envoy xDS resources from the specified Higress Gateway</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="新征程api-gateway">新征程：API Gateway<a href="#新征程api-gateway" class="hash-link" aria-label="新征程：API Gateway的直接链接" title="新征程：API Gateway的直接链接">​</a></h2><p>上面说了 Gateway API，接着我们聊聊 API Gateway 😄，API Gateway 有两层定义：</p><ol><li>狭义上：满足统一接入，将路由转发到不同服务的运维需求，即可称为 API Gateway；这里 API 的定义是服务的路由</li><li>广义上：在实现服务转发的基础上，需要识别带业务语义的接口，将业务能力 API 化管理，统一对外提供服务；这里 API 的定义是业务功能接口</li></ol><p>Higress 已经实现了狭义上的 API Gateway 能力，并且是基于 Gateway/Ingress API 这些通用路由标准来实现的。而与服务路由标准不同，业务功能接口的标准是 Swagger/OAS3/RPC IDL 等，做为 API Gateway 需要提供以下关键能力：</p><ol><li>支持通过上传 Swagger 等接口定义文件的方式导入 API</li><li>对 API 实现精细化策略管理，例如根据出入参定义实现参数映射/转换</li><li>实现以 API 方式开放能力时的认证/鉴权，调用量控制/审计能力</li></ol><p>Higress 新的开源征程将向具备业务 API 管理能力的 API Gateway 形态进发。在实现方式上，我们将基于 WASM 插件去扩展这一部分能力，这可以降低我们对上游 Envoy 社区的侵入性改造，同时让对 API 的精细化策略管理具备自定义扩展能力。
目前社区已经有一些 Proposal ，欢迎了解：</p><p><a href="https://github.com/alibaba/higress/issues/535" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/issues/535</a></p><p><a href="https://github.com/alibaba/higress/issues/601" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/higress/issues/601</a></p><p>欢迎有更多小伙伴加入，和我们一起踏上新的征程，有兴趣的小伙伴可以联系我(微信：nomadao)，加入 API Gateway 的 SIG（兴趣小组）。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="社区致谢">社区致谢<a href="#社区致谢" class="hash-link" aria-label="社区致谢的直接链接" title="社区致谢的直接链接">​</a></h2><p>首先要感谢 Envoy 和 Istio 社区，Higress 站在这两个软件的肩膀上演进能力，得以：</p><ol><li>通过 WASM 机制扩展 Envoy 数据面能力，持续不断地扩大网关插件生态</li><li>通过专注在网关领域，在 Istio 优秀的控制面基础上，进一步做抽象和简化，降低上手和运维门槛</li></ol><p>还要感谢参与 Higress 开源贡献的开发者们，这里重点感谢下为 1.3 版本做出核心贡献的开发者：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="maintainer董艺荃ch3cho">Maintainer：董艺荃(CH3CHO)<a href="#maintainer董艺荃ch3cho" class="hash-link" aria-label="Maintainer：董艺荃(CH3CHO)的直接链接" title="Maintainer：董艺荃(CH3CHO)的直接链接">​</a></h3><p>人如其名“艺全”，十八般武艺样样精通，不管是控制台 TS 前端，Java 后台，还是 Higress 的 GO 控制面，以及 Standalone 安装 Shell 脚本和各种 CICD 流程，通通手到擒来。</p><p>在 1.3 版本中主要负责了 Higress 支持 Gateway API 的能力，以及实现了 Higress Admin Java SDK 可以提供外部集成用于管理 Higress 配置，并改进了 Higress Console 的安全性和易用性。</p><p>除了开发贡献之外，他还对社区用户充满善意和热情，无论是在 GitHub 的 Issues/Discussions，或是社区交流微信/钉钉群，随处可见他帮助用户解决问题的身影。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="approver吴新军jun刘训灼xunzhuo">Approver：吴新军(Jun)，刘训灼(Xunzhuo)<a href="#approver吴新军jun刘训灼xunzhuo" class="hash-link" aria-label="Approver：吴新军(Jun)，刘训灼(Xunzhuo)的直接链接" title="Approver：吴新军(Jun)，刘训灼(Xunzhuo)的直接链接">​</a></h3><p>两位都在多个 Higress 版本为社区做出了贡献，Jun 的主要贡献有：在多注册中心的服务发现支持，全局配置管理架构抽象；Xunzhuo 的主要贡献有：Higress E2E 测试流程的搭建，GitHub CI 流程的建设，hgctl 的整体架构设计。</p><p>在 1.3 版本中二位协作完成了 hgctl 的多样化能力建设，帮助 Higress 的易用性又上到了一个新的台阶。</p><p>两位同学作为 Approver 积极参与社区贡献 PR 的 Review，目前分别是 Higress Tools SIG 和 Higress GatewayAPI SIG 的领导者。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="member韦鑫weixinx封宇腾fkbqf">Member：韦鑫(WeixinX)，封宇腾(Fkbqf)<a href="#member韦鑫weixinx封宇腾fkbqf" class="hash-link" aria-label="Member：韦鑫(WeixinX)，封宇腾(Fkbqf)的直接链接" title="Member：韦鑫(WeixinX)，封宇腾(Fkbqf)的直接链接">​</a></h3><p>两位都是通过中科院开源之夏（OSPP 2023）项目开始参与 Higress 贡献，WeixinX 是一名研二的学生，Fkbqf 是一名大三的学生。</p><p>在 1.3 版本中，WeixinX 实现了 hgctl plugin 子命令的能力，同时贡献了 Go 实现的 Basic Auth 插件，以及对标 Spring Cloud Gateway 请求响应转换能力的 Transformer 插件；Fkbqf 则实现了更为复杂的 OIDC 插件，具备比 Envoy 自带 OAuth2 Filter 更强大的功能，并且具备良好的扩展性。</p><p>两位同学除了开发贡献以外，用课余时间积极参与 Higress 社区周会，一起探讨和学习技术，不亦乐乎。能够成为你们人生学业进阶路上的阶梯，Higress 荣幸之至。</p><p>Higress 社区后续整体的 Roadmap 规划如下：</p><p><img loading="lazy" src="https://github.com/johnlanni/higress-group.github.io/assets/6763318/f646d9ad-d2d0-4496-b164-2884851e9e0c" alt="image" class="img_ev3q"></p><p>欢迎更多小伙伴一起加入我们：</p><p><img loading="lazy" src="https://github.com/johnlanni/higress-group.github.io/assets/6763318/d8e09712-0b3b-4c5a-b478-c84da139cf2f" alt="higress-comm" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="通过 Higress Wasm 插件 3 倍性能实现 Spring-cloud-gateway 功能"><meta itemprop="keywords" content="Higress,Wasm"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/plugin-transformer">通过 Higress Wasm 插件 3 倍性能实现 Spring-cloud-gateway 功能</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-10-27T00:00:00.000Z" itemprop="datePublished">2023年10月27日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">WeixinX</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><blockquote><p>导读: 本文将和大家一同回顾 Spring Cloud Gateway 是如何满足 HTTP 请求/响应转换需求场景的，并为大家介绍在这种场景下使用 Higress 云原生网关的解决方案，同时还对比了两者的性能差异。</p></blockquote><h1>1. SCG 修改请求/响应</h1><p>在 <a href="https://cloud.spring.io/spring-cloud-gateway/reference/html/" target="_blank" rel="noopener noreferrer">Spring Cloud Gateway</a> (以下简称为 SCG) 中，当我们需要对 HTTP 请求或响应进行修改时，SCG 提供了许多内置的 <a href="https://cloud.spring.io/spring-cloud-gateway/reference/html/#gatewayfilter-factories" target="_blank" rel="noopener noreferrer">GatewayFilter</a> 来满足我们对这种应用场景的需求，例如 AddRequestHeader,AddRequestParameter, DedupeResponseHeader,MapRequestHeader, ModifyRequestBody 等。</p><p>考虑以下简单用例：</p><ul><li>添加请求头部 X-First，值从请求路径中获取，例如从 /response-headers?testKey=testValue 中获取 &quot;response-headers&quot;；</li><li>将请求头部 X-First 的值映射给 X-Second；</li><li>添加请求查询参数 k1=v1；</li><li>剔除重复的响应头部 X-Dedupe。</li></ul><p>在 SCG 中使用 GatewayFilter 我们可以这样配置：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># application.yaml:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cloud</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">gateway</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">routes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test_route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">uri</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> lb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//httpbin</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">svc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">predicates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> Path=/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">/</span><span class="token important">**</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">filters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> AddRequestHeader=X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> MapRequestHeader=X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> AddRequestParameter=k1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DedupeResponseHeader=X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dedupe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RETAIN_FIRST</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>相信拥有 SCG 使用经验的同学对上述配置一定不陌生，那么本文将重点给出另一种能够<strong>满足上述需求并且性能更加优越的解决方案——使用 Higress 云原生网关的 Transformer 插件</strong>。</p><h1>2. Higress 插件与 SCG 性能比较</h1><p>我们在同一吞吐量水平（QPS）上，开启/关闭 <a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/transformer" target="_blank" rel="noopener noreferrer">Higress Transformer 插件</a> 和 SCG 相应 GatewayFilters，统计两者在 CPU 和内存资源上的开销。</p><p>经过<a href="https://gist.github.com/WeixinX/c24f4ded37832dd7e753b2d27470f0fc" target="_blank" rel="noopener noreferrer">测试</a>，我们得到的结论是：</p><ul><li>在 Higress 未启用 Transformer 插件，SCG 未启用 GatewayFilters 的条件下，SCG 的 CPU, 内存资源开销分别约为 Higress的 3.30, 4.88倍；</li><li>在 Higress 启用 Transformer 插件，SCG 启用相应 GatewayFilters 的条件下，SCG 的 CPU,内存资源开销分别约为 Higress 的 2.98, 3.19倍。</li></ul><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/61d3ec0b-b708-41e6-9f28-96108b4b55c6" alt="相同 QPS 下的 CPU 开销" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/a60415d5-bed6-47cf-a976-b8e55a818e14" alt="相同 QPS 下的内存开销" class="img_ev3q"></p><p><strong>可见 Higress Transformer 相比于 SCG GatewayFilter 有着相当不错的性能表现！</strong></p><p>接下来我们将进一步为大家介绍 Higress 云原生网关以及上述提到的 Higress Transformer 插件。</p><h1>3. Higress 简介</h1><p><a href="https://higress.io/zh-cn/" target="_blank" rel="noopener noreferrer">Higress</a> 是基于阿里内部的 Envoy Gateway 实践沉淀、以开源 Istio + Envoy 为核心构建的下一代云原生网关，实现了流量网关+微服务网关+安全网关三合一的高集成能力，深度集成 Dubbo、Nacos、Sentinel 等微服务技术栈，能够帮助用户极大地降低网关的部署及运维成本且能力不打折；在标准上全面支持 Ingress 与 Gateway API，积极拥抱云原生下的标准 API 规范；同时，Higress Controller 也支持 Nginx Ingress 平滑迁移，帮助用户零成本快速迁移到 Higress。
Higress 提供了一套 <a href="https://github.com/alibaba/higress/tree/main/plugins" target="_blank" rel="noopener noreferrer">Wasm (WebAssembly) SDK</a>，使得开发者能够轻松使用 C++，Golang，Rust 开发 Wasm 插件增强网关能力。下面将为大家介绍 Higress Transformer 插件的基本功能，最后简单说明 Transformer 插件的核心代码逻辑。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/c93bc55d-8cca-47ac-8b63-64168626f9a9" alt="Higress Architecture" class="img_ev3q"></p><h1>4. Transformer 插件介绍</h1><p>Higress Transformer 插件可以对请求/响应头部、请求查询参数、请求/响应体参数进行转换，支持的转换操作类型包括删除（remove）、重命名（rename）、更新（replace）、添加（add）、追加（append）、映射（map）和去重（dedupe）。</p><p>接下来我们复现最开始提到的 SCG GatewayFilter 简单用例，来演示如何使用该插件（以下使用 Higress 控制台可以很方便地部署插件，当然也可以使用 <a href="https://github.com/higress-group/higress-demo/tree/main/wasm-demo/wasm-plugin-transformer" target="_blank" rel="noopener noreferrer">K8s YAML Manifests 的方式</a>）：</p><ol><li>首先根据<a href="https://higress.io/zh-cn/docs/user/quickstart" target="_blank" rel="noopener noreferrer">官方文档</a> 快速安装 Higress，结果如下：</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl -n higress-system get deploy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console-grafana      </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-console-prometheus   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-controller           </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">higress-gateway              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           1d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>通过 Higress 控制台添加域名（foo.bar.com）、路由配置（foo），将流量转发至后端的 <a href="https://httpbin.org/" target="_blank" rel="noopener noreferrer">httpbin</a> 服务：</li></ol><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/4a6b2ed0-f42b-4ffa-8b36-99f7444a9e5f" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/151442fd-b43a-40e3-8fcf-7afa49f69af9" alt="image" class="img_ev3q"></p><ol start="3"><li>为 foo 路由添加 Transformer 插件（当前未推送插件至官方镜像仓库，可以先使用 docker.io/weixinx/transformer:v0.1.0，或到代码仓库自行构建）：</li></ol><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/fb522095-ee88-4f77-89c2-8a8547a3a96f" alt="image" class="img_ev3q"></p><p>注：为了能够同时完成请求和响应转换的需求，我们需要为 foo 路由再添加一个 Transformer 插件，命名为 transformer-resp，用于处理响应方向。</p><ol start="4"><li>添加 Transformer 配置并开启该插件：</li></ol><ul><li>添加请求头部 X-First，值从请求路径中获取，例如从 /response-headers?testKey=testValue 中获取 &quot;response-headers&quot;；</li><li>将请求头部 X-First 的值映射给 X-Second；</li><li>添加请求查询参数 k1=v1；</li><li>剔除重复的响应头部 X-Dedupe。</li></ul><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># transformer:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> request  </span><span class="token comment" style="color:#999988;font-style:italic"># 指定 Transformer 类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># 指定转换规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">operate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> add </span><span class="token comment" style="color:#999988;font-style:italic"># 指定转换操作类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># 指定头部转换规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $1  </span><span class="token comment" style="color:#999988;font-style:italic"># 正则表达式捕获组 $1，支持 RE2 语法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path_pattern</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ^\/(\w+)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">\</span><span class="token punctuation" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">.</span><span class="token important">*$</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">querys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 指定查询参数转换规则</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">operate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">First</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># transformer-resp:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">operate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dedupe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">headers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dedupe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> RETAIN_FIRST</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="5"><li>发送请求进行测试：</li></ol><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 验证请求方向转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">$ curl -v -H &quot;host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo.bar.com&quot; &quot;127.0.0.1/get&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">&quot;args&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 添加了查询参数 k1=v1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;k1&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">&quot;headers&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;X-First&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;get&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 添加了请求头部 X-First，值 &quot;get&quot; 来自请求路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">&quot;X-Second&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;get&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 映射了请求头部 X-Second</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 添加了查询参数 k1=v1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">&quot;url&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://foo.bar.com/get?k1=v1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 验证响应方向转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">$ curl -v -H &quot;host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> foo.bar.com&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;127.0.0.1/response</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">Dedupe=1</span><span class="token important">&amp;X-Dedupe=2&amp;X-Dedupe=3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt; HTTP/1.1 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">&lt; x-dedupe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 保留了响应头部 X-Dedupe 的第一个值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 通过查询参数传给 httpbin 的自定义响应头部</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">&quot;X-Dedupe&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>❗️需要注意的是：</p><ul><li>与上述例子相同，若有同时处理请求和响应转换的需求，则需要为相应路由添加两个 Transformer 插件，分别处理请求方向和响应方向（正在优化）；</li><li>请求体支持的 Content-Type 有：application/json, application/x-www-form-urlencoded, multipart/form-data；而响应体仅支持 application/json；</li><li>更多说明详见<a href="https://github.com/alibaba/higress/tree/main/plugins/wasm-go/extensions/transformer" target="_blank" rel="noopener noreferrer">插件文档</a>。</li></ul><h1>5. Transformer 逻辑</h1><p>本节将简单说明 Higress Transformer 插件的核心代码逻辑，希望可以为有兴趣优化该插件或进行二次开发的同学提供一些帮助。</p><p>首先该插件代码位于Higress 仓库的 plugins/wasm-go/extensions/transformer 目录下，使用 Higress 提供的 <a href="https://github.com/alibaba/higress/tree/main/plugins" target="_blank" rel="noopener noreferrer">Wasm SDK</a> 进行开发（关于如何开发 Wasm 插件详见<a href="https://higress.io/zh-cn/docs/user/wasm-go" target="_blank" rel="noopener noreferrer">官方文档</a>）。</p><p>插件的配置模型 TransformerConfig：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 模型以插件配置的形式暴露给用户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> TransformerConfig </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  typ   </span><span class="token builtin">string</span><span class="token plain">          # Transformer 类型，</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rules </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">TransformRule # 转换规则</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  trans Transformer # Transformer 实例，不对用户暴露配置，用于实际的转换操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> TransformRule </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  operate </span><span class="token builtin">string</span><span class="token plain">   # 转换操作类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  headers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">Param  # header 参数 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  querys  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">Param  # query 参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  body    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">Param  # body 参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Param </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key         </span><span class="token builtin">string</span><span class="token plain"> # 表示字段的 key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       </span><span class="token builtin">string</span><span class="token plain"> # 表示字段的 value 或 key </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> 或 strategy </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dedupe</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  valueType   </span><span class="token builtin">string</span><span class="token plain"> # 为 application</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">json body 指定 value 的数据类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hostPattern </span><span class="token builtin">string</span><span class="token plain"> # host 正则匹配模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pathPattern </span><span class="token builtin">string</span><span class="token plain"> # path 正则匹配模式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中 Transformer 作为接口分别有请求和响应两个实现（requestTransformer, responseTransformer），主要实现了 3 个接口方法 TransformHeaders,TransformerQuerys 和 TransformBody：</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Transformer </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">TransformHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hs </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">TransformQuerys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> qs </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">TransformBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> path </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> Transformer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">requestTransformer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> Transformer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">responseTransformer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>由于头部（Headers）和查询参数（Querys）都是以 key-value 的形式存在，因此通过 kvHandler 对两者采用统一的处理逻辑；而 Body 由于请求、响应支持不同的 Content-Type，因此分别通过 requestBodyHandler (kvHandler, jsonHandler 组合)和 responseBodyHandler (jsonHandler) 进行处理。综上，在修改该插件逻辑时，主要对 kvHandler 和 jsonHandler 进行修改即可，其中 jsonHandler 依赖 <a href="https://github.com/tidwall/gjson" target="_blank" rel="noopener noreferrer">GJSON</a> 和 <a href="https://github.com/tidwall/sjson" target="_blank" rel="noopener noreferrer">SJSON</a> 工具库。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/fc08ff0c-12ec-4dfd-b946-4e83f8431174" alt="image" class="img_ev3q"></p><p>目前 handler 中的转换顺序是被硬编码的（remove -&gt; rename -&gt; replace -&gt; add -&gt; append -&gt; map -&gt; dedupe），我们对此有优化的打算，也欢迎感兴趣的同学参与进来 ~</p><h1>6. 总结</h1><p>本文带大家了解了 Higress Transformer 插件，并与 Spring Cloud Gateway 进行了性能比较，在文章的最后还说明了该插件的核心代码逻辑，希望能够为大家从 Spring Cloud Gateway 迁移至 Higress 提供帮助！</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/49450531/c2a47afd-5f29-4cfc-b5c5-571d2265ec19" alt="image" class="img_ev3q"></p><p>如果您觉得 Higress 对您有帮助，欢迎前往 <a href="https://github.com/alibaba/higress" target="_blank" rel="noopener noreferrer">Github: Higress</a> 为我们 star⭐️ 一下！期待与您在 Higress 社区相遇 ~</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="看K8s资深运维如何选型Ingress网关"><meta itemprop="keywords" content="Higress,KubeCon"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/zh-cn/blog/2023-kubecon">Higress在2023 KubeCon China的分享</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2023-09-28T00:00:00.000Z" itemprop="datePublished">2023年9月28日</time> · <!-- -->阅读需 9 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">澄潭</span></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="分享简介">分享简介<a href="#分享简介" class="hash-link" aria-label="分享简介的直接链接" title="分享简介的直接链接">​</a></h2><p>在9月26日的2023 KubeCon阿里云云原生开放日，Higress的分享内容分为两部分：</p><p>Part 1. 由上海费芮网络科技系统运维副总监戴喜军，带来费芮在选型企业版Higress作为K8s Ingress替代Nginx Ingress的介绍</p><p>Part 2. 由Higress开源社区负责人澄潭，带来Higress开源项目的介绍</p><p>开源版和企业版是Higress的一体两面，通过本次分享，相信大家会对Higress有更全面的了解。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-1-费芮互动使用higress作为kubernetes-ingress实现稳定性和性能提升">Part 1. 费芮互动使用Higress作为Kubernetes Ingress实现稳定性和性能提升<a href="#part-1-费芮互动使用higress作为kubernetes-ingress实现稳定性和性能提升" class="hash-link" aria-label="Part 1. 费芮互动使用Higress作为Kubernetes Ingress实现稳定性和性能提升的直接链接" title="Part 1. 费芮互动使用Higress作为Kubernetes Ingress实现稳定性和性能提升的直接链接">​</a></h2><p>费芮通过Higress解决了原本Nginx Ingress网关的诸多痛点，性能提升90%，响应时间下降50%，并大幅提升业务入口的稳定及安全性，高效支撑每日1亿+粉丝交互， 4万+线下门店、每月3000万+笔的移动支付需求。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="费芮业务场景">费芮业务场景<a href="#费芮业务场景" class="hash-link" aria-label="费芮业务场景的直接链接" title="费芮业务场景的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/0d4f761d-1471-49b6-a03c-38b11304262d" alt="image" class="img_ev3q">
<img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/dba8ae2a-93c8-4368-af3d-739f97090d39" alt="image" class="img_ev3q"></p><p>费芮专注于移动营销、O2O、社交媒体、移动电商领域的创新与研发。费芮互动自主研发的自媒体平台运维超过2亿粉丝 ； 有超过4万家线下门店采用费芮O2O解决方案。费芮的主要客户包括优衣库，必胜客，肯德基，星巴克，SPG，欧莱雅，Innisfree，迪卡侬，顶新集团等。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/61791bae-b40c-4b90-bc4d-c23bc052911c" alt="image" class="img_ev3q"></p><p>费芮内部业务系统的日均发布次数达到100次之多，会涉及到400多条Ingress路由规则的日常更新，且网关每天需要承载的PV流量达到了1个亿。Ingress网关的性能和稳定性至关重要。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-ingress-痛点">Nginx Ingress 痛点<a href="#nginx-ingress-痛点" class="hash-link" aria-label="Nginx Ingress 痛点的直接链接" title="Nginx Ingress 痛点的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/1d8a178e-05de-4114-96b3-7d4e11240374" alt="image" class="img_ev3q"></p><p>配置变更频繁，导致Nginx进程频繁重启，大量连接瞬时断开后并发重连会导致后端服务产生压力，严重时造成大量请求失败。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/52e6ff5a-7374-4fe9-b001-ff6d3ac97744" alt="image" class="img_ev3q"></p><p>Nginx Ingress的Controller组件和Nginx组件运行在同一个POD中，控制面资源使用还会影响到数据面的性能。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/b09a3db4-465b-46b8-8e35-bd274388f143" alt="image" class="img_ev3q"></p><p>Nginx Ingress还缺少面向服务限流的能力，只能实现面向单个来源IP限流，对于后端服务保护来说没有意义。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higress-收益">Higress 收益<a href="#higress-收益" class="hash-link" aria-label="Higress 收益的直接链接" title="Higress 收益的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/48388f01-7796-4f7d-b7d1-fb7bd1522925" alt="image" class="img_ev3q"></p><p>Higress企业版采用了全托管架构，与业务集群分离，无需自己运维，稳定性有更好保障。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/5e689364-fb08-4ec1-9d71-49539da561b8" alt="image" class="img_ev3q"></p><p>配置更新都是动态加载，无需重启数据面，保障业务平稳发布，websocket连接的业务收益也特别明显，长连接可以始终保持不会断开。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/29ae8168-e84d-41fb-bb4f-a258c4200a7e" alt="image" class="img_ev3q"></p><p>开启了TLS硬件加速，TLS握手时延直接减半，QPS吞吐提升86%。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/4ace2996-5b5a-4331-90cb-8448c65042d5" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/8664f436-c058-42bc-82c9-7355d24592ad" alt="image" class="img_ev3q"></p><p>开启WAF对吞吐影响还是比较明显的，下降了30%，但相比Ingress Nginx直接下降了90%，性能提升还是很明显，而且更大的优势是基于阿里云WAF产品，防护规则是实时更新的，而非Modsecurity的静态规则。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/10fca63d-a0bb-45a1-82ee-de115bf577e7" alt="image" class="img_ev3q"></p><p>Higress集成了Sentinel限流的能力，可以直接面向服务的QPS吞吐上限/并发数上线进行限流，并且相比Nginx只能配置单机限制阈值，需要关注网关节点数量，Higress这里的配置是全局阈值，不受网关扩缩容影响。</p><p>触发限流后可以自定义响应内容或者重定向到指定地址，都是很实用的能力。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="part-2-higress开源之路扎根开源生态定义云原生网关">Part 2. Higress开源之路：扎根开源生态，定义云原生网关<a href="#part-2-higress开源之路扎根开源生态定义云原生网关" class="hash-link" aria-label="Part 2. Higress开源之路：扎根开源生态，定义云原生网关的直接链接" title="Part 2. Higress开源之路：扎根开源生态，定义云原生网关的直接链接">​</a></h2><p>开源是云原生生态的基石，Higress也是借助了开源生态的力量，站在Istio/Envoy的肩膀上开发出了更多实用的功能，我们选择将MSE Higress（企业版）中的核心能力全部开源，决心扎根在开源生态中，让Higress变得更普惠，有更多人使用，从而让Higress更加强大。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="简介">简介<a href="#简介" class="hash-link" aria-label="简介的直接链接" title="简介的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/438dcf9a-96fa-4d0d-89ed-e810746c61ab" alt="image" class="img_ev3q"></p><p>Higress实际上有三次诞生过程：第一次是在阿里集团内部业务需求驱动下诞生；第二次是随着内部使用逐渐成熟沉淀为阿里云上的MSE Higress云原生网关产品；第三次是随着云产品成熟，2022年11月在云栖大会上正式宣布开源。2023年5月Release了第一个GA版本，意味着开源版本也走入成熟阶段。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/783b96cc-b628-4784-a6cf-c2cf10e11f3f" alt="image" class="img_ev3q"></p><p>从配置流转的过程来看Higress的架构：</p><ol><li>首先用户可以通过UI控制台/命令行工具多种方式来下发配置</li><li>到了控制面，如果是K8s下，配置持久化基于CRD，如果不是K8s，配置持久化基于Nacos</li><li>除了用户下发的路由配置，实现服务路由还需要的服务IP地址信息，支持从K8s service/Nacos/Eureka/Consul/ZooKeeper/DNS/固定IP等多种方式获取</li><li>Higress数据面是基于Envoy，配置通过xDS下发，这里复用了Istio的配置下发机制，因为是内置了这个机制，无需单独部署Istio</li><li>最终配置下发到数据面生效，Higress基于Envoy扩展了很多能力，而且基于Wasm扩展机制，可以很方便开发自定义插件，且具备全局/域名/路由维度的生效粒度</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="核心能力">核心能力<a href="#核心能力" class="hash-link" aria-label="核心能力的直接链接" title="核心能力的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/be02b599-f82f-42be-a8e5-82f69b9196b8" alt="image" class="img_ev3q">
<img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/4dc3cc2b-d6fe-4717-a53a-3e75c5f826ca" alt="image" class="img_ev3q"></p><p>高集成：同时集成经典微服务生态和K8s开源生态能力，可以帮助业务从传统架构迁移到云原生架构，基于流量灰度等能力，可以保障这一过程的平滑</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/87f8eacd-39b6-4a26-a7a1-b78f6a5abb4f" alt="image" class="img_ev3q"></p><p>标准化：兼容Nginx Ingress常用注解，基于统一的Ingress标准可以轻松实现Nginx到Higress这一技术鸿沟的跨越，Higress也已经支持Gateway API，路由标准本身也能借助Higress实现平滑升级</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/33776d12-baf3-4d09-ae42-a5cadb655bef" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/b9e4a718-c985-4ac4-9b7b-46a427ccb987" alt="image" class="img_ev3q"></p><p>易扩展：借助Higress的Wasm SDK，很少的业务代码就可以开发一个灵活的插件；并且支持基于OCI镜像标准分发，可以让插件的文档，配置约束等跟随插件本身一起被分发和共享；和传统Nginx类网关最大的差别，在于插件的分发集成阶段，实现了插件版本更新跟网关自身版本更新的解耦。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/d037bd1d-89c1-4f9c-b489-857b46de31ca" alt="image" class="img_ev3q"></p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/65f71cee-09d9-4e7b-aa6e-bd4c9a60de83" alt="image" class="img_ev3q"></p><p>热更新：Envoy相比Nginx更合理的配置系统抽象，让Higress具备了Nginx Ingress无法实现的配置热更新能力</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="回顾与展望">回顾与展望<a href="#回顾与展望" class="hash-link" aria-label="回顾与展望的直接链接" title="回顾与展望的直接链接">​</a></h3><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/f46c4d68-8e31-44bb-afc6-c02c9fccb105" alt="image" class="img_ev3q"></p><p>Higress开源的前半年，专注于开源生态的打通和易用性的提升，并基于Github Action构建了开源的集成测试体系，来保障项目质量，在今年5月份发布第一个GA稳定版本后，在多个核心社区开发者的努力下，我们又很快发布了1.1和1.2两个大版本，推出了非K8s部署/Knative支持等重量级功能。</p><p><img loading="lazy" src="https://github.com/higress-group/higress-group.github.io/assets/6763318/3ba10a71-b3f0-4ede-a150-c64e0b1003c4" alt="image" class="img_ev3q"></p><p>未来的RoadMap，Higress会聚焦在Gateway API/插件生态/API管理三个方向上，随着社区开发团队的不断壮大，Higress已经建立了多个不同方向的<a href="https://github.com/alibaba/higress/issues/547" target="_blank" rel="noopener noreferrer">SIG</a> 并行推进核心功能演进，未来将不断有重量级功能推出，尽请期待。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="直播回看">直播回看<a href="#直播回看" class="hash-link" aria-label="直播回看的直接链接" title="直播回看的直接链接">​</a></h2><p><a href="https://www.aliyun.com/activity/middleware/CloudNative_Meetup" target="_blank" rel="noopener noreferrer">https://www.aliyun.com/activity/middleware/CloudNative_Meetup</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/zh-cn/blog/page/2"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">愿景</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/">为用户提供一站式云原生网关解决方案.</a></li></ul></div><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/overview/what-is-higress">Higress是什么?</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/docs/user/quickstart">快速开始</a></li><li class="footer__item"><a href="https://github.com/higress-group/higress-group.github.io/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item">报告文档问题<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/higress-group/higress-group.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">在GitHub上编辑此文档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">资源</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-cn/blog">博客</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-cn/community">社区</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="//img.alicdn.com/imgextra/i2/O1CN01oNTGgE1lfW7oEPIzP_!!6000000004846-2-tps-960-290.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="120" height="36"><img src="//img.alicdn.com/imgextra/i2/O1CN01oNTGgE1lfW7oEPIzP_!!6000000004846-2-tps-960-290.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="120" height="36"></div><div class="footer__copyright">Copyright © 2023 Higress<br>浙公网安备 33011002016922号 浙ICP备12022327号-1119</div></div></div></footer></div>
<script src="/zh-cn/assets/js/runtime~main.eafa2191.js"></script>
<script src="/zh-cn/assets/js/main.52b6581f.js"></script>
</body>
</html>